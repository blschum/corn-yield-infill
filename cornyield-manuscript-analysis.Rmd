---
title: "Corn Yield Prediction ~ ranger() RF"
author: "Britta Schumacher"
date: "Last updated: `r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    theme: yeti
    toc: yes
    toc_float: true
    code_folding: hide
---

### Packages

```{r message = FALSE, warning = FALSE}
library(tidyverse)
library(ggplot2)
library(caret)
library(ie2misc)
library(MLmetrics)
library(ranger)
library(pdp)
```

## Build training and test sets for: all data, pruned biophysical data, and pruned farm(er) data
```{r train and test}
# bring in all data
geoid_bio <- readRDS("./data/data-out/true-train.RDS") %>% 
  select(GEOID, YEAR,YIELD,PERC_IRR,FRR,GDD,BV2,BV18,SDI_CDL_AG,BV9,BV4,TP,ELEVATION,S_PH_H2O,SLOPE,BV8,BV19,T_CEC_SOIL,BV15,T_REF_BULK_DENSITY,T_OC)
geoid_farmer <- readRDS("./data/data-out/true-train.RDS") %>% 
  select(GEOID, YEAR,YIELD,PERC_IRR,FRR,GDD,BV2,BV18,SDI_CDL_AG,BV9,BV4,TP,ELEVATION,S_PH_H2O,SLOPE,BV8,BV19,T_CEC_SOIL,BV15,T_REF_BULK_DENSITY,T_OC,perc_corn,chem,fert,labor_expense,machinery,insur_acres,gvt_prog,exp,occup,tenant,acres_per_op)
# pull in all data with recorded yield
train <- readRDS("./data/data-out/for-RF-analysis/bio_train.RDS") # bio
test <- readRDS("./data/data-out/for-RF-analysis/bio_test.RDS") # bio
farmer_train <- readRDS("./data/data-out/for-RF-analysis/farmer_train.RDS") # farmer + bio
farmer_test <- readRDS("./data/data-out/for-RF-analysis/farmer_test.RDS") # farmer + bio

# bring in true test, county-years without recorded yield BUT with attributes
truetest <- readRDS("./data/data-out/true-test-infillobs.RDS")

truetest$YEAR <- as.factor(truetest$YEAR)
truetest$FRR <- as.factor(truetest$FRR)

# subset for only biophysical variables
infill_bioph <- truetest %>% 
  dplyr::select(YEAR,YIELD,PERC_IRR,FRR,GDD,BV2,BV18,SDI_CDL_AG,BV9,BV4,TP,ELEVATION,S_PH_H2O,SLOPE,BV8,BV19,T_CEC_SOIL,BV15,T_REF_BULK_DENSITY,T_OC)

# subset for biophysical AND farm(er) variables
infill_farmer <- truetest %>% select(YEAR,YIELD,PERC_IRR,FRR,GDD,BV2,BV18,SDI_CDL_AG,BV9,BV4,TP,ELEVATION,S_PH_H2O,SLOPE,BV8,BV19,T_CEC_SOIL,BV15,T_REF_BULK_DENSITY,T_OC,perc_corn,chem,fert,labor_expense,machinery,insur_acres,gvt_prog,exp,occup,tenant,acres_per_op)
```

###########################
# Biophysical RFs
###########################

# Biophysical RF using optimal ranger from tune-RF

ntree = 2000, mtry = 7, node size = 4, sample size = 0.800 ~ OOB RMSE = 17.54877
```{r}
detach(package:dplyr)
set.seed(1234)
# @Brennan, I had been running 100 iterations of RF and averaging; hash out for loop to run single

#for (iter in 1:100){ 
#cat(paste('iter = ', iter, ':: '))
  
  # train the model
  rf <- ranger(formula          = YIELD ~ ., 
               data             = train, 
               num.trees        = 2000,
               mtry             = 7, 
               min.node.size    = 4,
               sample.fraction  = 0.8,
               importance       = "permutation")
  
  # test the model
  preds <- predict(rf, data = test)
  preds <- as.data.frame(preds$predictions)
  colnames(preds) <- "PREDS"
  test <- cbind(test, preds) 
  
  # infill 
  infill <- predict(rf, infill_bioph, type = "response")
  infill <- as.data.frame(infill$predictions)
  colnames(infill) <- "INFILL"
  infill_bioph <- cbind(infill_bioph, infill) 

  # performance on test set
  RMSE <- caret::RMSE(test$PREDS, test$YIELD)
  R2 <- 1 - (sum((test$YIELD - test$PREDS)^2) / sum((test$YIELD - mean(test$YIELD))^2))
  MAE <- mae(test$PREDS, test$YIELD)
  MAPE <- MAPE(test$PREDS, test$YIELD)
  
  # build argument to feed save, below
  list <- list("RMSE" = RMSE, "R2" = R2, "MAE" = MAE, "MAPE" = MAPE, "var_exp" = rf)
  print(list)
  
  # variable importance
  imp <- as.data.frame(rf$variable.importance)
  imp$Variable <- row.names(imp)
  colnames(imp) <- c("VI", "VAR")
  ranger_imp <- imp
  
  # save .RDS's
  saveRDS(test, file = paste0('./results/ranger-preds/bio_RFpreds.RDS'))
  saveRDS(imp, file = paste0('./results/ranger-imp/bio_RFimp.RDS'))
  saveRDS(infill_bioph, file = paste0('./results/ranger-infill/bio_infill.RDS'))

  # USE SAVE CODE BELOW IF RUNNING ITERATIONS OF RF
  # save .RDS's
  #saveRDS(test, file = paste0('./results/ranger-preds/bio_RFpreds_',iter,'.RDS'))
  #saveRDS(imp, file = paste0('./results/ranger-imp/bio_RFimp_',iter,'.RDS'))
  #saveRDS(infill_bioph, file = paste0('./results/ranger-infill/bio_infill_',iter,'.RDS'))

#}

# Partial dependence, taken from the first iteration of ranger, above
pdp_irr <- pdp::partial(rf,pred.var = "PERC_IRR")
saveRDS(pdp_irr, "./results/ranger-pdp/irr.RDS")
pdp_gdd <- pdp::partial(rf,pred.var = "GDD")
saveRDS(pdp_gdd, "./results/ranger-pdp/GDD.RDS")
pdp_bv2 <- pdp::partial(rf,pred.var = "BV2")
saveRDS(pdp_bv2, "./results/ranger-pdp/BV2.RDS")
pdp_dsi <- pdp::partial(rf,pred.var = "SDI_CDL_AG")
saveRDS(pdp_dsi, "./results/ranger-pdp/SDI.RDS")
pdp_ph <- pdp::partial(rf,pred.var = "S_PH_H2O")
saveRDS(pdp_ph, "./results/ranger-pdp/pH.RDS")
pdp_bv18 <- pdp::partial(rf,pred.var = "BV18")
saveRDS(pdp_bv18, "./results/ranger-pdp/BV18.RDS")
```

## Take the average of the performance results for *n* = 100 RFs
```{r}
# @Brennan, I had been running 100 iterations of RF and averaging; if only running one, all code below unnecessary 
#library(tidyverse)
# build full list of files and bring them into the R environment
#bioph <- readRDS("./results/ranger-preds/bio_RFpreds_100.RDS")

#names(bioph)[21:ncol(bioph)] <- unlist(mapply(function(x,y) paste(x, seq(1,y), sep="_"), "PREDS", 100))

#bioph <- bioph %>% pivot_longer(cols = c(21:120), names_to = "PRED_NUM", values_to = "PREDS") %>% select(-PRED_NUM)

#prediction_bioph <- merge(bioph, corn_bioph, by = c("YEAR","YIELD","PERC_IRR","FRR","GDD","BV2","BV18","SDI_CDL_AG","BV9","BV4","TP","ELEVATION","S_PH_H2O","SLOPE","BV8","BV19","T_CEC_SOIL","BV15","T_REF_BULK_DENSITY","T_OC"))

#prediction_bioph <- prediction_bioph %>% select(GEOID, everything())

#prediction_bioph_summary <- prediction_bioph %>% 
  #mutate(FRR = as.numeric(FRR)) %>% 
  #dplyr::group_by(GEOID, YEAR, YIELD) %>% 
  #summarize(average_prediction = ave(PREDS)) %>% 
  #distinct() %>% 
  #mutate(error = YIELD - average_prediction)

#saveRDS(prediction_bioph_summary, "./data/data-out/ensemble_bioph_preds.RDS")

# overall performance
# performance on test set
  #b_RMSE <- caret::RMSE(prediction_bioph_summary$average_prediction, prediction_bioph_summary$YIELD)
  #b_R2 <- 1 - (sum((prediction_bioph_summary$YIELD - prediction_bioph_summary$average_prediction)^2) / sum((prediction_bioph_summary$YIELD - mean(prediction_bioph_summary$YIELD))^2))
  #b_MAE <- mae(prediction_bioph_summary$average_prediction, prediction_bioph_summary$YIELD)
  #b_MAPE <- MAPE(prediction_bioph_summary$average_prediction, prediction_bioph_summary$YIELD)
  
  # build argument to feed save, below
  #bioph_list <- list("RMSE" = b_RMSE, "R2" = b_R2, "MAE" = b_MAE, "MAPE" = b_MAPE)
  #print(bioph_list)
```

## Take the average of the variable importance results for *n* = 100 RFs
```{r}
# @Brennan, I had been running 100 iterations of RF and averaging; if only running one, all code below unnecessary 
# build full list of files and bring them into the R environment
#bioph_imp <- list.files(path = "./results/ranger-imp/",
#                    pattern = "bio", full.names = T, all.files = T) %>% 
#  map_dfr(readRDS) %>% 
#  group_by(VAR) %>% 
#  summarise(ave_imp = mean(VI),
#            sd_imp = sd(VI)) %>% 
#  mutate(VAR = as.factor(VAR))

# variable importance plo
#bioph_imp$VAR_NAME <- c("Precipitation Seasonality", "Precipitation of the warmest quarter", "Precipitation of the coldest quarter", "Mean diurnal range", "Temperature seasonality", "Mean temperature of the wettest quarter", "Mean temperature of the driest quarter", "Elevation", "Farm Resource Region", "Growing degree days", "Percent irrigated acreage", "Subsoil pH", "Shannon's Diversity Index", "Slope", "Topsoil cation exchange capacity", "Topsoil organic carbon", "Topsoil reference bulk density", "Total precipitation", "Year")

#bioph_imp <- bioph_imp %>%  mutate(Prop = ave_imp/sum(ave_imp)*100)

#saveRDS(imp_red, file = './results/RFimp_red.RDS')

#bioph_imp_plot <- ggplot(bioph_imp, aes(x=reorder(VAR_NAME, ave_imp), y=ave_imp)) + 
#  geom_point() +
#  geom_segment(aes(x=VAR_NAME,xend=VAR_NAME,y=0,yend=ave_imp)) +
#  ylab("Increase in node purity") +
#  xlab("") +
#  coord_flip() +
#  theme_minimal()

#bioph_imp_plot
```


### Biophysical RF using optimal ranger from tune-RF & all available covariates - to compare model performance on full v. subset
```{r}
bio_full <- readRDS("./data/all-available-BIOPH-attributes.RDS")

bio_full_train <- merge(train, bio_full, by = c("YEAR","YIELD","PERC_IRR","FRR","GDD","BV2","BV18","SDI_CDL_AG","BV9","BV4","TP","ELEVATION","S_PH_H2O","SLOPE","BV8","BV19","T_CEC_SOIL","BV15","T_REF_BULK_DENSITY","T_OC"))

bio_full_train <- bio_full_train %>% select(!GEOID)

bio_full_test <- merge(test, bio_full, by = c("YEAR","YIELD","PERC_IRR","FRR","GDD","BV2","BV18","SDI_CDL_AG","BV9","BV4","TP","ELEVATION","S_PH_H2O","SLOPE","BV8","BV19","T_CEC_SOIL","BV15","T_REF_BULK_DENSITY","T_OC"))

bio_full_test <- bio_full_test %>% select(!GEOID)

set.seed(1234)

#for (iter in 1:10){
#  cat(paste('iter = ', iter, ':: '))
  # train the model
  rf <- ranger(formula          = YIELD ~ ., 
               data             = bio_full_train, 
               num.trees        = 2000,
               mtry             = 19, 
               min.node.size    = 4,
               sample.fraction  = 0.8,
               importance       = "permutation")
  
  # test the model
  preds <- predict(rf, data = bio_full_test)
  preds <- as.data.frame(preds$predictions)
  colnames(preds) <- "PREDS"
  test <- cbind(bio_full_test, preds) 

  saveRDS(test, file = paste0('./results/ranger-preds/bio_full_RFpreds.RDS'))
  #saveRDS(test, file = paste0('./results/ranger-preds/bio_full_RFpreds_',iter,'.RDS'))
  
#}

# build full list of files and bring them into the R environment
bio_full <- list.files(path = "./results/ranger-preds/",
                    pattern = "bio_full", full.names = T, all.files = T) %>% 
  map_dfr(readRDS) 

prediction_full_bio <- merge(bio_full, geoid_bio, by = c("YEAR","YIELD","PERC_IRR","FRR","GDD","BV2","BV18","SDI_CDL_AG","BV9","BV4","TP","ELEVATION","S_PH_H2O","SLOPE","BV8","BV19","T_CEC_SOIL","BV15","T_REF_BULK_DENSITY","T_OC"))

# build prediction data.frame
prediction_full_bio_summary <- prediction_full_bio %>% 
  #mutate(FRR = as.numeric(FRR)) %>% 
  group_by(GEOID, YEAR, YIELD) %>% 
  summarize(average_prediction = ave(PREDS)) %>% 
  distinct() %>% 
  mutate(error = YIELD - average_prediction)

#saveRDS(prediction_full_farm_summary, "./data/data-out/ensemble_full_farm_preds.RDS")

# overall performance
  fb_RMSE <- caret::RMSE(prediction_full_bio_summary$average_prediction, prediction_full_bio_summary$YIELD)
  fb_R2 <- 1 - (sum((prediction_full_bio_summary$YIELD - prediction_full_bio_summary$average_prediction)^2) / sum((prediction_full_bio_summary$YIELD - mean(prediction_full_bio_summary$YIELD))^2))
  fb_MAE <- mae(prediction_full_bio_summary$average_prediction, prediction_full_bio_summary$YIELD)
  fb_MAPE <- MAPE(prediction_full_bio_summary$average_prediction, prediction_full_bio_summary$YIELD)

  full_bio_list <- list("RMSE" = fb_RMSE, "R2" = fb_R2, "MAE" = fb_MAE, "MAPE" = fb_MAPE)
  print(full_bio_list)
```

###########################
# Farm(er) RFs
###########################

# Farm(er) RF using optimal ranger from tune-RF

ntree = 2000, mtry = 19, node size = 4, sample size = 0.800, OOB RMSE = 17.53468
```{r}
# @Brennan, I had been running 100 iterations of RF and averaging; hashed out for loop to run single
set.seed(1234)

#for (iter in 1:1){
#  cat(paste('iter = ', iter, ':: '))
  
  # train the model
  rf <- ranger(formula          = YIELD ~ ., 
               data             = farmer_train, 
               num.trees        = 2000,
               mtry             = 19, 
               min.node.size    = 4,
               sample.fraction  = 0.8,
               importance       = "permutation")
  
  # test the model
  preds <- predict(rf, data = farmer_test)
  preds <- as.data.frame(preds$predictions)
  colnames(preds) <- "PREDS"
  test <- cbind(farmer_test, preds) 
  
  # infill 
  infill <- predict(rf, infill_farmer, type = "response")
  infill <- as.data.frame(infill$predictions)
  colnames(infill) <- "INFILL"
  infill_farmer <- cbind(infill_farmer, infill) 

  # performance on test set
  RMSE <- caret::RMSE(test$PREDS, test$YIELD)
  R2 <- 1 - (sum((test$YIELD - test$PREDNS)^2) / sum((test$YIELD - mean(test$YIELD))^2))
  MAE <- mae(test$PREDS, test$YIELD)
  MAPE <- MAPE(test$PREDS, test$YIELD)
  
  # build argument to feed save, below
  list <- list("RMSE" = RMSE, "R2" = R2, "MAE" = MAE, "MAPE" = MAPE, "var_exp" = rf)
  print(list)
  
  # variable importance
  imp <- as.data.frame(rf$variable.importance)
  imp$Variable <- row.names(imp)
  colnames(imp) <- c("VI", "VAR")
  ranger_imp <- imp
  
  saveRDS(test, file = paste0('./results/ranger-preds/farmer_RFpreds.RDS'))
  saveRDS(imp, file = paste0('./results/ranger-imp/farmer_RFimp.RDS'))
  saveRDS(infill_farmer, file = paste0('./results/ranger-infill/farmer_infill.RDS'))
  
  # USE SAVE CODE BELOW IF RUNNING ITERATIONS OF RF
  # save .RDS's
  #saveRDS(test, file = paste0('./results/ranger-preds/farmer_RFpreds_',iter,'.RDS'))
  #saveRDS(imp, file = paste0('./results/ranger-imp/farmer_RFimp_',iter,'.RDS'))
  #saveRDS(infill_farmer, file = paste0('./results/ranger-infill/farmer_infill_',iter,'.RDS'))

#}

# Partial dependence, taken from the first iteration of ranger, above
pdp_fert <- pdp::partial(rf,pred.var = "fert")
saveRDS(pdp_fert, "./results/ranger-pdp/fert.RDS")
pdp_chem <- pdp::partial(rf,pred.var = "chem")
saveRDS(pdp_chem, "./results/ranger-pdp/chem.RDS")
pdp_corn <- pdp::partial(rf,pred.var = "perc_corn")
saveRDS(pdp_corn, "./results/ranger-pdp/corn_acreage.RDS")
pdp_insur <- pdp::partial(rf,pred.var = "insur_acres")
saveRDS(pdp_insur, "./results/ranger-pdp/insur.RDS")
pdp_gvt <- pdp::partial(rf,pred.var = "gvt_prog")
saveRDS(pdp_gvt, "./results/ranger-pdp/gvt_prog.RDS")
```

## Take the average of the results for n = 100 RFs
```{r}
# @Brennan, I had been running 100 iterations of RF and averaging; if only running one, all code below unnecessary 
#library(tidyverse)
# build full list of files and bring them into the R environment
#farm <- list.files(path = "./results/ranger-preds/",
#                    pattern = "farmer", full.names = T, all.files = T) %>% 
#  map_dfr(readRDS) 

#prediction_farm <- merge(farm, corn_bioph, by = c("YEAR","YIELD","PERC_IRR","FRR","GDD","BV2","BV18","SDI_CDL_AG","BV9","BV4","TP","ELEVATION","S_PH_H2O","SLOPE","BV8","BV19","T_CEC_SOIL","BV15","T_REF_BULK_DENSITY","T_OC"))

#library(tidyverse)
#prediction_farm_summary <- prediction_farm %>% 
  #mutate(FRR = as.numeric(FRR)) %>% 
  #group_by(GEOID, YEAR, YIELD) %>% 
  #summarize(average_prediction = ave(PREDS)) %>% 
  #distinct() %>% 
  #mutate(error = YIELD - average_prediction)

#saveRDS(prediction_farm_summary, "./data/data-out/ensemble_farm_preds.RDS")

# overall performance
# performance on test set
  #f_RMSE <- caret::RMSE(prediction_farm_summary$average_prediction, prediction_farm_summary$YIELD)
  #f_R2 <- 1 - (sum((prediction_farm_summary$YIELD - prediction_farm_summary$average_prediction)^2) / sum((prediction_farm_summary$YIELD - mean(prediction_farm_summary$YIELD))^2))
  #f_MAE <- mae(prediction_farm_summary$average_prediction, prediction_farm_summary$YIELD)
  #f_MAPE <- MAPE(prediction_farm_summary$average_prediction, prediction_farm_summary$YIELD)
  
  # build argument to feed save, below
  #farmer_list <- list("RMSE" = f_RMSE, "R2" = f_R2, "MAE" = f_MAE, "MAPE" = f_MAPE)
  #print(farmer_list)
```

## Take the average of the variable importance results for *n* = 100 RFs
```{r}
# @Brennan, I had been running 100 iterations of RF and averaging; if only running one, all code below unnecessary 
# build full list of files and bring them into the R environment
#farmer_imp <- list.files(path = "./results/ranger-imp/",
#                    pattern = "farm", full.names = T, all.files = T) %>% 
#  map_dfr(readRDS) %>% 
#  group_by(VAR) %>% 
#  summarise(ave_imp = mean(VI),
#            sd_imp = sd(VI)) %>% 
#  mutate(VAR = as.factor(VAR))

# variable importance plo
#farmer_imp$VAR_NAME <- c("Precipitation Seasonality", "Precipitation of the warmest quarter", "Precipitation of the coldest quarter", "Mean diurnal range", "Temperature seasonality", "Mean temperature of the wettest quarter", "Mean temperature of the driest quarter", "Elevation", "Farm Resource Region", "Growing degree days", "Percent irrigated acreage", "Subsoil pH", "Shannon's Diversity Index", "Slope", "Topsoil cation exchange capacity", "Topsoil organic carbon", "Topsoil reference bulk density", "Total precipitation", "Year")

#farmer_imp <- farmer_imp %>%  mutate(Prop = ave_imp/sum(ave_imp)*100)

#saveRDS(imp_red, file = './results/RFimp_red.RDS')

#farmer_imp_plot <- ggplot(bioph_imp, aes(x=reorder(VAR_NAME, ave_imp), y=ave_imp)) + 
#  geom_point() +
#  geom_segment(aes(x=VAR_NAME,xend=VAR_NAME,y=0,yend=ave_imp)) +
#  ylab("Increase in node purity") +
#  xlab("") +
#  coord_flip() +
#  theme_minimal()

#farmer_imp_plot
```

### Farm(er) RF using optimal ranger from tune-RF & all available covariates - to compare model performance on full v. subset
```{r}
farmer_full <- readRDS("./data/all-available-FARMER-attributes.RDS")

farmer_full_train <- merge(farmer_train, farmer_full, by = c("YEAR","YIELD","PERC_IRR","FRR","GDD","BV2","BV18","SDI_CDL_AG","BV9","BV4","TP","ELEVATION","S_PH_H2O","SLOPE","BV8","BV19","T_CEC_SOIL","BV15","T_REF_BULK_DENSITY","T_OC","chem", "fert","labor_expense","machinery","perc_corn","gvt_prog","insur_acres","exp","occup","tenant","acres_per_op"))

farmer_full_train <- farmer_full_train %>% select(!GEOID)

farmer_full_test <- merge(farmer_test, farmer_full, by = c("YEAR","YIELD","PERC_IRR","FRR","GDD","BV2","BV18","SDI_CDL_AG","BV9","BV4","TP","ELEVATION","S_PH_H2O","SLOPE","BV8","BV19","T_CEC_SOIL","BV15","T_REF_BULK_DENSITY","T_OC","chem", "fert","labor_expense","machinery","perc_corn","gvt_prog","insur_acres","exp","occup","tenant","acres_per_op"))

farmer_full_test <- farmer_full_test %>% select(!GEOID)

set.seed(1234)

#for (iter in 1:10){
#  cat(paste('iter = ', iter, ':: '))
  # train the model
  rf <- ranger(formula          = YIELD ~ ., 
               data             = farmer_full_train, 
               num.trees        = 2000,
               mtry             = 19, 
               min.node.size    = 4,
               sample.fraction  = 0.8,
               importance       = "permutation")
  
  # test the model
  preds <- predict(rf, data = farmer_full_test)
  preds <- as.data.frame(preds$predictions)
  colnames(preds) <- "PREDS"
  test <- cbind(farmer_full_test, preds) 

  saveRDS(test, file = paste0('./results/ranger-preds/farmer_full_RFpreds.RDS'))
  #saveRDS(test, file = paste0('./results/ranger-preds/farmer_full_RFpreds_',iter,'.RDS'))
  
#}

# build full list of files and bring them into the R environment
farm_full <- list.files(path = "./results/ranger-preds/",
                    pattern = "farmer_full", full.names = T, all.files = T) %>% 
  map_dfr(readRDS) 

prediction_full_farm <- merge(farm_full, geoid_farmer, by = c("YEAR","YIELD","PERC_IRR","FRR","GDD","BV2","BV18","SDI_CDL_AG","BV9","BV4","TP","ELEVATION","S_PH_H2O","SLOPE","BV8","BV19","T_CEC_SOIL","BV15","T_REF_BULK_DENSITY","T_OC"))

# build prediction data.frame
prediction_full_farm_summary <- prediction_full_farm %>% 
  #mutate(FRR = as.numeric(FRR)) %>% 
  group_by(GEOID, YEAR, YIELD) %>% 
  summarize(average_prediction = ave(PREDS)) %>% 
  distinct() %>% 
  mutate(error = YIELD - average_prediction)

#saveRDS(prediction_full_farm_summary, "./data/data-out/ensemble_full_farm_preds.RDS")

# overall performance
  ff_RMSE <- caret::RMSE(prediction_full_farm_summary$average_prediction, prediction_full_farm_summary$YIELD)
  ff_R2 <- 1 - (sum((prediction_full_farm_summary$YIELD - prediction_full_farm_summary$average_prediction)^2) / sum((prediction_full_farm_summary$YIELD - mean(prediction_full_farm_summary$YIELD))^2))
  ff_MAE <- mae(prediction_full_farm_summary$average_prediction, prediction_full_farm_summary$YIELD)
  ff_MAPE <- MAPE(prediction_full_farm_summary$average_prediction, prediction_full_farm_summary$YIELD)

  full_farmer_list <- list("RMSE" = ff_RMSE, "R2" = ff_R2, "MAE" = ff_MAE, "MAPE" = ff_MAPE)
  print(full_farmer_list)
```

###########################
# Infill 
###########################

## Take the average of the infill results for *n* = 100 biophysical RFs
```{r}
# @Brennan, I had been running 100 iterations of RF and averaging; if only running one, all code below unnecessary 
# build full list of files and bring them into the R environment
bioph_infill <- readRDS("./results/ranger-infill/bio_infill.RDS")
#bioph_infill <- readRDS("./results/ranger-infill/bio_infill_100.RDS")

#names(bioph_infill)[21:ncol(bioph_infill)] <- unlist(mapply(function(x,y) paste(x, seq(1,y), sep="_"), "PREDS", 100))

#bioph_infill <- bioph_infill %>% pivot_longer(cols = c(21:120), names_to = "PRED_NUM", values_to = "PREDS") %>% select(-PRED_NUM)

infill <- readRDS("./data/true-test-infillobs.RDS")
bioph_infill <- merge(bioph_infill, infill, by = c("YEAR","PERC_IRR","FRR","GDD","BV2","BV18","SDI_CDL_AG","BV9","BV4","TP","ELEVATION","S_PH_H2O","SLOPE","BV8","BV19","T_CEC_SOIL","BV15","T_REF_BULK_DENSITY","T_OC"))

  
bioph_infill <- bioph_infill %>% 
  select("GEOID", "YEAR", "INFILL")

colnames(farmer_infill) <- c("GEOID", "YEAR", "BIOPH")

#bioph_infill_summary <- bioph_infill %>% 
#  #mutate(FRR = as.numeric(FRR)) %>% 
#  dplyr::group_by(GEOID, YEAR) %>% 
#  summarize(average_prediction = ave(PREDS)) %>% 
#  distinct() 

#saveRDS(bioph_infill_summary, "./data/data-out/ensemble_bioph_infill.RDS")
```

## Take the average of the infill results for *n* = 100 farm(er) RFs
```{r}
# @Brennan, I had been running 100 iterations of RF and averaging; if only running one, all code below unnecessary 
# build full list of files and bring them into the R environment
farmer_infill <- readRDS("./results/ranger-infill/farmer_infill.RDS")
#farmer_infill <- readRDS("./results/ranger-infill/farmer_infill_100.RDS")
#farmer_infill <- farmer_infill[-c(32:33)]

#names(farmer_infill)[32:ncol(farmer_infill)] <- unlist(mapply(function(x,y) paste(x, seq(1,y), sep="_"), "PREDS", 100))

#farmer_infill <- farmer_infill %>% pivot_longer(cols = c(32:131), names_to = "PRED_NUM", values_to = "PREDS") %>% select(-PRED_NUM)

farmer_infill <- merge(farmer_infill, infill, by = c("YEAR","PERC_IRR","FRR","GDD","BV2","BV18","SDI_CDL_AG","BV9","BV4","TP","ELEVATION","S_PH_H2O","SLOPE","BV8","BV19","T_CEC_SOIL","BV15","T_REF_BULK_DENSITY","T_OC","chem", "fert","labor_expense","machinery","perc_corn","gvt_prog","insur_acres","exp","occup","tenant","acres_per_op")) 
  
farmer_infill <- farmer_infill %>% 
  select("GEOID", "YEAR", "INFILL")

colnames(farmer_infill) <- c("GEOID", "YEAR", "FARMER")

#farmer_infill_summary <- farmer_infill %>% 
  #mutate(FRR = as.numeric(FRR)) %>% 
#  dplyr::group_by(GEOID, YEAR) %>% 
#  summarize(average_prediction = ave(PREDS)) %>% 
#  distinct() 

#saveRDS(farmer_infill_summary, "./data/data-out/ensemble_farmer_infill.RDS")
```

## Compare biophysical and farm(er) predictions
```{r}
infill_diff <- merge(bioph_infill, farmer_infill, by = c("GEOID", "YEAR"))

infill_diff <- infill_diff %>% 
  mutate(DIFF = BIOPH-FARMER)

saveRDS(infill_diff, "./data/data-out/ensemble_infill_diff.RDS")
```
