---
title: "Corn Yield Prediction ~ ranger() RF"
author: "Britta Schumacher"
date: "Last updated: `r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    theme: yeti
    toc: yes
    toc_float: true
    code_folding: hide
---

### Packages

```{r message = FALSE, warning = FALSE}
library(tidyverse)
library(ggplot2)
library(caret)
library(ie2misc)
library(MLmetrics)
library(ranger)
library(pdp)
library(sf)
```

## 0.0 Build training and test sets for: all data, pruned biophysical data, and pruned farm(er) data
```{r train and test}
# bring in all data
geoid_bio <- readRDS("./data/data-out/true-train.RDS") %>% 
  select(GEOID, YEAR,YIELD,PERC_IRR,FRR,GDD,BV2,BV18,SDI_CDL_AG,BV9,BV4,TP,ELEVATION,S_PH_H2O,SLOPE,BV8,BV19,T_CEC_SOIL,BV15,T_REF_BULK_DENSITY,T_OC)
geoid_farmer <- readRDS("./data/data-out/true-train.RDS") %>% 
  select(GEOID, YEAR,YIELD,PERC_IRR,FRR,GDD,BV2,BV18,SDI_CDL_AG,BV9,BV4,TP,ELEVATION,S_PH_H2O,SLOPE,BV8,BV19,T_CEC_SOIL,BV15,T_REF_BULK_DENSITY,T_OC,perc_corn,chem,fert,labor_expense,machinery,insur_acres,gvt_prog,exp,occup,tenant,acres_per_op)
# pull in all data with recorded yield
train <- readRDS("./data/data-out/for-RF-analysis/bio_train.RDS") # bio
test <- readRDS("./data/data-out/for-RF-analysis/bio_test.RDS") # bio
farmer_train <- readRDS("./data/data-out/for-RF-analysis/farmer_train.RDS") # farmer + bio
farmer_test <- readRDS("./data/data-out/for-RF-analysis/farmer_test.RDS") # farmer + bio

# bring in true test, county-years without recorded yield BUT with attributes
truetest <- readRDS("./data/data-out/true-test-infillobs.RDS")

truetest$FRR <- as.factor(truetest$FRR)

# subset for only biophysical variables
infill_bioph <- truetest %>% 
  dplyr::select(YEAR,YIELD,PERC_IRR,FRR,GDD,BV2,BV18,SDI_CDL_AG,BV9,BV4,TP,ELEVATION,S_PH_H2O,SLOPE,BV8,BV19,T_CEC_SOIL,BV15,T_REF_BULK_DENSITY,T_OC)

# subset for biophysical AND farm(er) variables
infill_farmer <- truetest %>% select(YEAR,YIELD,PERC_IRR,FRR,GDD,BV2,BV18,SDI_CDL_AG,BV9,BV4,TP,ELEVATION,S_PH_H2O,SLOPE,BV8,BV19,T_CEC_SOIL,BV15,T_REF_BULK_DENSITY,T_OC,perc_corn,chem,fert,labor_expense,machinery,insur_acres,gvt_prog,exp,occup,tenant,acres_per_op)
```

###########################
# 1.0 Biophysical RFs
###########################

## 1.1.1 Biophysical RF using optimal ranger from tune-RF, and training-test sets

ntree = 2000, mtry = 7, node size = 4, sample size = 0.800 ~ OOB RMSE = 17.54877
```{r}
#detach(package:dplyr)
set.seed(1234)
# @Brennan, I had been running 100 iterations of RF and averaging; hash out for loop to run single

#for (iter in 1:100){ 
#cat(paste('iter = ', iter, ':: '))
  
  # train the model
  rf <- ranger(formula          = YIELD ~ ., 
               data             = train, 
               #num.trees        = 2000,
               #mtry             = 7, 
               #min.node.size    = 4,
               #sample.fraction  = 0.8,
               importance       = "permutation")
  
  # test the model
  preds <- predict(rf, data = test)
  preds <- as.data.frame(preds$predictions)
  colnames(preds) <- "PREDS"
  test <- cbind(test, preds) 
  
  # infill 
  infill <- predict(rf, infill_bioph, type = "response")
  infill <- as.data.frame(infill$predictions)
  colnames(infill) <- "INFILL"
  infill_bioph <- cbind(infill_bioph, infill) 

  # performance on test set
  RMSE <- caret::RMSE(test$PREDS, test$YIELD)
  R2 <- 1 - (sum((test$YIELD - test$PREDS)^2) / sum((test$YIELD - mean(test$YIELD))^2))
  MAE <- mae(test$PREDS, test$YIELD)
  MAPE <- MAPE(test$PREDS, test$YIELD)
  
  # build argument to feed save, below
  list <- list("RMSE" = RMSE, "R2" = R2, "MAE" = MAE, "MAPE" = MAPE, "var_exp" = rf)
  print(list)
  
  # variable importance
  imp <- as.data.frame(rf$variable.importance)
  imp$Variable <- row.names(imp)
  colnames(imp) <- c("VI", "VAR")
  ranger_imp <- imp
  
  # save .RDS's
  saveRDS(test, file = paste0('./results/ranger-preds/bio_RFpreds.RDS'))
  saveRDS(imp, file = paste0('./results/ranger-imp/bio_RFimp.RDS'))
  saveRDS(infill_bioph, file = paste0('./results/ranger-infill/bio_infill.RDS'))

  # USE SAVE CODE BELOW IF RUNNING ITERATIONS OF RF
  # save .RDS's
  #saveRDS(test, file = paste0('./results/ranger-preds/bio_RFpreds_',iter,'.RDS'))
  #saveRDS(imp, file = paste0('./results/ranger-imp/bio_RFimp_',iter,'.RDS'))
  #saveRDS(infill_bioph, file = paste0('./results/ranger-infill/bio_infill_',iter,'.RDS'))

#}
```

### 1.1.2 Biophysical RF using optimal ranger from tune-RF & all available covariates, and training-test sets. Compare full variable-set test performance versus reduced variable-set test performance. 
```{r}
bio_full <- readRDS("./data/all-available-BIOPH-attributes.RDS")

bio_full_train <- merge(train, bio_full, by = c("YEAR","YIELD","PERC_IRR","FRR","GDD","BV2","BV18","SDI_CDL_AG","BV9","BV4","TP","ELEVATION","S_PH_H2O","SLOPE","BV8","BV19","T_CEC_SOIL","BV15","T_REF_BULK_DENSITY","T_OC"))

bio_full_train <- bio_full_train %>% select(!GEOID)

bio_full_test <- merge(test, bio_full, by = c("YEAR","YIELD","PERC_IRR","FRR","GDD","BV2","BV18","SDI_CDL_AG","BV9","BV4","TP","ELEVATION","S_PH_H2O","SLOPE","BV8","BV19","T_CEC_SOIL","BV15","T_REF_BULK_DENSITY","T_OC"))

#bio_full_test <- bio_full_test %>% select(!GEOID)

set.seed(1234)

#for (iter in 1:10){
#  cat(paste('iter = ', iter, ':: '))
  # train the model
  rf <- ranger(formula          = YIELD ~ ., 
               data             = bio_full_train, 
               num.trees        = 2000,
               mtry             = 19, 
               min.node.size    = 4,
               sample.fraction  = 0.8,
               importance       = "permutation")
  
  # test the model
  preds <- predict(rf, data = bio_full_test)
  preds <- as.data.frame(preds$predictions)
  colnames(preds) <- "PREDS"
  test <- cbind(bio_full_test, preds) 

  saveRDS(test, file = paste0('./results/ranger-preds/bio_full_RFpreds.RDS'))
  #saveRDS(test, file = paste0('./results/ranger-preds/bio_full_RFpreds_',iter,'.RDS'))
  
#}

# build full list of files and bring them into the R environment
bio_full <- list.files(path = "./results/ranger-preds/",
                    pattern = "bio_full", full.names = T, all.files = T) %>% 
  map_dfr(readRDS) 

prediction_full_bio <- merge(bio_full, geoid_bio, by = c("YEAR","YIELD","PERC_IRR","FRR","GDD","BV2","BV18","SDI_CDL_AG","BV9","BV4","TP","ELEVATION","S_PH_H2O","SLOPE","BV8","BV19","T_CEC_SOIL","BV15","T_REF_BULK_DENSITY","T_OC"))

# build prediction data.frame
prediction_full_bio_summary <- prediction_full_bio %>% 
  #mutate(FRR = as.numeric(FRR)) %>% 
  group_by(GEOID, YEAR, YIELD) %>% 
  summarize(average_prediction = ave(PREDS)) %>% 
  distinct() %>% 
  mutate(error = YIELD - average_prediction)

#saveRDS(prediction_full_farm_summary, "./data/data-out/ensemble_full_farm_preds.RDS")

# overall performance
  fb_RMSE <- caret::RMSE(prediction_full_bio_summary$average_prediction, prediction_full_bio_summary$YIELD)
  fb_R2 <- 1 - (sum((prediction_full_bio_summary$YIELD - prediction_full_bio_summary$average_prediction)^2) / sum((prediction_full_bio_summary$YIELD - mean(prediction_full_bio_summary$YIELD))^2))
  fb_MAE <- mae(prediction_full_bio_summary$average_prediction, prediction_full_bio_summary$YIELD)
  fb_MAPE <- MAPE(prediction_full_bio_summary$average_prediction, prediction_full_bio_summary$YIELD)

  full_bio_list <- list("RMSE" = fb_RMSE, "R2" = fb_R2, "MAE" = fb_MAE, "MAPE" = fb_MAPE)
  print(full_bio_list)
```

## 1.2.1 Biophysical RF using ranger defaults, and 50 runs of 5-fold cross validation.
```{r}

# Add coordinates to county data. 
counties <- readRDS("data/county.RDS")
counties <- st_as_sf(counties)
county_centroid <- sf::st_centroid(counties)
county_join <- county_centroid %>% 
  dplyr::mutate(lon = sf::st_coordinates(.)[,1],
                lat = sf::st_coordinates(.)[,2]) %>%
  as.data.frame(.) %>%
  dplyr::select(GEOID, lon, lat)
space_data <- dplyr::left_join(corn_yield, county_join, by = "GEOID")
saveRDS(space_data, "./data/data-out/panel.RDS")
bio_rf_cv <- dplyr::left_join(geoid_bio, county_join, by = "GEOID") 
bio_rf_cv <- bio_rf_cv %>% select(!GEOID)

for(iter in 1:50){
  cat(paste('iter = ', iter, ':: '))
  
  groups <- sample(rep(1:5, length.out = nrow(bio_rf_cv)))
  preds <- vector("numeric", nrow(bio_rf_cv)) - 1
  
  for(i in 1:5){
    train <- bio_rf_cv[groups != i, ]
    test <- bio_rf_cv[groups == i, ]
    
    tfit <- ranger::ranger(YIELD ~ ., 
                           train, 
                           importance = "permutation")
    preds[groups == i] <- predict(tfit, test)$predictions
  
  }
     preds

    saveRDS(preds, paste0('./results/ranger-preds/bio_RFpredscv_',iter,'.RDS'))
  }

# build full list of files and bring them into the R environment
bio_cv <- list.files(path = "./results/ranger-preds/",
                    pattern = "bio_RFpredscv", full.names = T, all.files = T) 
bio_cv <- purrr::map(bio_cv, readRDS)
bio_cv_df <- as.data.frame(bio_cv)
names <- c()
for(i in 1:50){
  names[i] <- c(paste0("preds_",i))
}

colnames(bio_cv_df) <- c(names)
saveRDS(bio_cv_df, "./results/biocv_preds.RDS")

biocv_preds <-readRDS("./results/biocv_preds.RDS")
biofull_cvpreds <- cbind(geoid_bio,biocv_preds)

biofull_cvpreds <- biofull_cvpreds %>% 
  select(GEOID,YIELD,YEAR,22:71) 

biofull_cvpreds$average_prediction = apply(biofull_cvpreds[,4:53], 1, mean)
biofull_cvpreds$median_prediction = apply(biofull_cvpreds[,4:53], 1, median)

biofull_cvpreds <- biofull_cvpreds %>% 
  mutate(error = YIELD - average_prediction)
saveRDS(biofull_cvpreds, "./results/biofull_cvpreds_ave.RDS")

# performance on verage
  RMSE <- caret::RMSE(biofull_cvpreds$average_prediction, biofull_cvpreds$YIELD)
  R2 <- 1 - (sum((biofull_cvpreds$YIELD - biofull_cvpreds$average_prediction)^2) / sum((biofull_cvpreds$YIELD - mean(biofull_cvpreds$YIELD))^2))
  
  # build argument to feed save, below
  list <- list("RMSE" = RMSE, "R2" = R2)
  print(list)
```

## 1.2.2 Biophysical RF using ranger defaults, resubstitution for Variable Importance
```{r}
set.seed(1234)
resub_bio_vi <- ranger(formula          = YIELD ~ ., 
               data             = bio_rf_cv, 
               replace = TRUE,
               num.trees        = 2000,
               importance       = "permutation")

  imp <- as.data.frame(resub_bio_vi$variable.importance)
  imp$Variable <- row.names(imp)
  colnames(imp) <- c("VI", "VAR")
  farmer_imp <- imp
  
  saveRDS(imp, file = paste0('./results/ranger-imp/bio_resub_RFimp.RDS'))
  
  # Partial dependence, taken from the first iteration of ranger, above
pdp_irr <- pdp::partial(resub_bio_vi,pred.var = "PERC_IRR")
saveRDS(pdp_irr, "./results/ranger-pdp/irr.RDS")
pdp_gdd <- pdp::partial(resub_bio_vi,pred.var = "GDD")
saveRDS(pdp_gdd, "./results/ranger-pdp/GDD.RDS")
pdp_bv2 <- pdp::partial(resub_bio_vi,pred.var = "BV2")
saveRDS(pdp_bv2, "./results/ranger-pdp/BV2.RDS")
pdp_dsi <- pdp::partial(resub_bio_vi,pred.var = "SDI_CDL_AG")
saveRDS(pdp_dsi, "./results/ranger-pdp/SDI.RDS")
pdp_bv18 <- pdp::partial(resub_bio_vi,pred.var = "BV18")
saveRDS(pdp_bv18, "./results/ranger-pdp/BV18.RDS")
```

###########################
# 2.0 Farm(er) RFs
###########################

## 2.1.1 Farm(er) RF using optimal ranger from tune-RF, and training-test sets

ntree = 2000, mtry = 19, node size = 4, sample size = 0.800, OOB RMSE = 17.53468
```{r}
# @Brennan, I had been running 100 iterations of RF and averaging; hashed out for loop to run single
set.seed(1234)

#for (iter in 1:1){
#  cat(paste('iter = ', iter, ':: '))
  
  # train the model
  rf <- ranger(formula          = YIELD ~ ., 
               data             = farmer_train, 
               num.trees        = 2000,
               mtry             = 19, 
               min.node.size    = 4,
               sample.fraction  = 0.8,
               importance       = "permutation")
  
  # test the model
  preds <- predict(rf, data = farmer_test)
  preds <- as.data.frame(preds$predictions)
  colnames(preds) <- "PREDS"
  test <- cbind(farmer_test, preds) 
  
  # infill 
  infill <- predict(rf, infill_farmer, type = "response")
  infill <- as.data.frame(infill$predictions)
  colnames(infill) <- "INFILL"
  infill_farmer <- cbind(infill_farmer, infill) 

  # performance on test set
  RMSE <- caret::RMSE(test$PREDS, test$YIELD)
  R2 <- 1 - (sum((test$YIELD - test$PREDS)^2) / sum((test$YIELD - mean(test$YIELD))^2))
  MAE <- mae(test$PREDS, test$YIELD)
  MAPE <- MAPE(test$PREDS, test$YIELD)
  
  # build argument to feed save, below
  list <- list("RMSE" = RMSE, "R2" = R2, "MAE" = MAE, "MAPE" = MAPE, "var_exp" = rf)
  print(list)
  
  # variable importance
  imp <- as.data.frame(rf$variable.importance)
  imp$Variable <- row.names(imp)
  colnames(imp) <- c("VI", "VAR")
  ranger_imp <- imp
  
  saveRDS(test, file = paste0('./results/ranger-preds/farmer_RFpreds.RDS'))
  saveRDS(imp, file = paste0('./results/ranger-imp/farmer_RFimp.RDS'))
  saveRDS(infill_farmer, file = paste0('./results/ranger-infill/farmer_infill.RDS'))
  
  # USE SAVE CODE BELOW IF RUNNING ITERATIONS OF RF
  # save .RDS's
  #saveRDS(test, file = paste0('./results/ranger-preds/farmer_RFpreds_',iter,'.RDS'))
  #saveRDS(imp, file = paste0('./results/ranger-imp/farmer_RFimp_',iter,'.RDS'))
  #saveRDS(infill_farmer, file = paste0('./results/ranger-infill/farmer_infill_',iter,'.RDS'))

#}
```

## 2.1.2 Farm(er) RF using optimal ranger from tune-RF & all available covariates, and training-test sets. Compare full variable-set test performance versus reduced variable-set test performance. 
```{r}
farmer_full <- readRDS("./data/all-available-FARMER-attributes.RDS")

farmer_full_train <- merge(farmer_train, farmer_full, by = c("YEAR","YIELD","PERC_IRR","FRR","GDD","BV2","BV18","SDI_CDL_AG","BV9","BV4","TP","ELEVATION","S_PH_H2O","SLOPE","BV8","BV19","T_CEC_SOIL","BV15","T_REF_BULK_DENSITY","T_OC","chem", "fert","labor_expense","machinery","perc_corn","gvt_prog","insur_acres","exp","occup","tenant","acres_per_op"))

farmer_full_train <- farmer_full_train %>% select(!GEOID)

farmer_full_test <- merge(farmer_test, farmer_full, by = c("YEAR","YIELD","PERC_IRR","FRR","GDD","BV2","BV18","SDI_CDL_AG","BV9","BV4","TP","ELEVATION","S_PH_H2O","SLOPE","BV8","BV19","T_CEC_SOIL","BV15","T_REF_BULK_DENSITY","T_OC","chem", "fert","labor_expense","machinery","perc_corn","gvt_prog","insur_acres","exp","occup","tenant","acres_per_op"))

farmer_full_test <- farmer_full_test %>% select(!GEOID)

set.seed(1234)

#for (iter in 1:10){
#  cat(paste('iter = ', iter, ':: '))
  # train the model
  rf <- ranger(formula          = YIELD ~ ., 
               data             = farmer_full_train, 
               num.trees        = 2000,
               mtry             = 19, 
               min.node.size    = 4,
               sample.fraction  = 0.8,
               importance       = "permutation")
  
  # test the model
  preds <- predict(rf, data = farmer_full_test)
  preds <- as.data.frame(preds$predictions)
  colnames(preds) <- "PREDS"
  test <- cbind(farmer_full_test, preds) 

  saveRDS(test, file = paste0('./results/ranger-preds/farmer_full_RFpreds.RDS'))
  #saveRDS(test, file = paste0('./results/ranger-preds/farmer_full_RFpreds_',iter,'.RDS'))
  
#}

# build full list of files and bring them into the R environment
farm_full <- list.files(path = "./results/ranger-preds/",
                    pattern = "farmer_full", full.names = T, all.files = T) %>% 
  map_dfr(readRDS) 

prediction_full_farm <- merge(farm_full, geoid_farmer, by = c("YEAR","YIELD","PERC_IRR","FRR","GDD","BV2","BV18","SDI_CDL_AG","BV9","BV4","TP","ELEVATION","S_PH_H2O","SLOPE","BV8","BV19","T_CEC_SOIL","BV15","T_REF_BULK_DENSITY","T_OC"))

# build prediction data.frame
prediction_full_farm_summary <- prediction_full_farm %>% 
  #mutate(FRR = as.numeric(FRR)) %>% 
  group_by(GEOID, YEAR, YIELD) %>% 
  summarize(average_prediction = ave(PREDS)) %>% 
  distinct() %>% 
  mutate(error = YIELD - average_prediction)

#saveRDS(prediction_full_farm_summary, "./data/data-out/ensemble_full_farm_preds.RDS")

# overall performance
  ff_RMSE <- caret::RMSE(prediction_full_farm_summary$average_prediction, prediction_full_farm_summary$YIELD)
  ff_R2 <- 1 - (sum((prediction_full_farm_summary$YIELD - prediction_full_farm_summary$average_prediction)^2) / sum((prediction_full_farm_summary$YIELD - mean(prediction_full_farm_summary$YIELD))^2))
  ff_MAE <- mae(prediction_full_farm_summary$average_prediction, prediction_full_farm_summary$YIELD)
  ff_MAPE <- MAPE(prediction_full_farm_summary$average_prediction, prediction_full_farm_summary$YIELD)

  full_farmer_list <- list("RMSE" = ff_RMSE, "R2" = ff_R2, "MAE" = ff_MAE, "MAPE" = ff_MAPE)
  print(full_farmer_list)
```

## 2.2.1 Farm(er) RF using ranger defaults, and 50 runs of 5-fold cross validation.
```{r}
farmer_rf_cv <- dplyr::left_join(geoid_farmer, county_join, by = "GEOID") 
farmer_rf_cv <- farmer_rf_cv %>% select(!GEOID)
set.seed(1234)
for(iter in 1:50){
  cat(paste('iter = ', iter, ':: '))
  
  groups <- sample(rep(1:5, length.out = nrow(farmer_rf_cv)))
  preds <- vector("numeric", nrow(farmer_rf_cv)) - 1
  
  for(i in 1:5){
    train <- farmer_rf_cv[groups != i, ]
    test <- farmer_rf_cv[groups == i, ]
    
    tfit <- ranger::ranger(YIELD ~ ., 
                           train, 
                           importance = "permutation")
    preds[groups == i] <- predict(tfit, test)$predictions
  
  }
     preds

    saveRDS(preds, paste0('./results/ranger-preds/farmer_RFpredscv_',iter,'.RDS'))
  }

# build full list of files and bring them into the R environment
farmer_cv <- list.files(path = "./results/ranger-preds/",
                    pattern = "farmer_RFpredscv", full.names = T, all.files = T) 

farmer_cv <- purrr::map(farmer_cv, readRDS)

farmer_cv_df <- as.data.frame(farmer_cv)

names <- c()
for(i in 1:50){
  names[i] <- c(paste0("preds_",i))
}

colnames(farmer_cv_df) <- c(names)
saveRDS(farmer_cv_df, "./results/farmercv_preds.RDS")

farmercv_preds <-readRDS("./results/farmercv_preds.RDS")
farmerfull_cvpreds <- cbind(geoid_farmer,farmercv_preds)

farmerfull_cvpreds <- farmerfull_cvpreds %>% 
  select(GEOID,YIELD,YEAR,33:82) 

farmerfull_cvpreds$average_prediction = apply(farmerfull_cvpreds[,4:53], 1, mean)
farmerfull_cvpreds$median_prediction = apply(farmerfull_cvpreds[,4:53], 1, median)

farmerfull_cvpreds <- farmerfull_cvpreds %>% 
  mutate(error = YIELD - average_prediction)
saveRDS(farmerfull_cvpreds, "./results/farmerfull_cvpreds_ave.RDS")
farmerfull_cvpreds <- readRDS("./results/farmerfull_cvpreds_ave.RDS")
# performance on verage
  RMSE <- caret::RMSE(farmerfull_cvpreds$average_prediction, farmerfull_cvpreds$YIELD)
  R2 <- 1 - (sum((farmerfull_cvpreds$YIELD - farmerfull_cvpreds$average_prediction)^2) / sum((farmerfull_cvpreds$YIELD - mean(farmerfull_cvpreds$YIELD))^2))
  
  # build argument to feed save, below
  list <- list("RMSE" = RMSE, "R2" = R2)
  print(list)
```

## 2.2.2 Farm(er) RF using ranger defaults, resubstitution for Variable Importance
```{r}
set.seed(1234)
resub_farmer_vi <- ranger(formula          = YIELD ~ ., 
               data             = farmer_rf_cv, 
               num.trees        = 2000,
               replace = TRUE,
               importance       = "permutation")

  imp <- as.data.frame(resub_farmer_vi$variable.importance)
  imp$Variable <- row.names(imp)
  colnames(imp) <- c("VI", "VAR")
  farmer_imp <- imp
  
  saveRDS(imp, file = paste0('./results/ranger-imp/farmer_resub_RFimp.RDS'))
  
# Partial dependence, taken from the first iteration of ranger, above
pdp_fert <- pdp::partial(resub_farmer_vi,pred.var = "fert")
saveRDS(pdp_fert, "./results/ranger-pdp/fert.RDS")
pdp_chem <- pdp::partial(resub_farmer_vi,pred.var = "chem")
saveRDS(pdp_chem, "./results/ranger-pdp/chem.RDS")
pdp_corn <- pdp::partial(resub_farmer_vi,pred.var = "perc_corn")
saveRDS(pdp_corn, "./results/ranger-pdp/corn_acreage.RDS")
pdp_insur <- pdp::partial(resub_farmer_vi,pred.var = "insur_acres")
saveRDS(pdp_insur, "./results/ranger-pdp/insur.RDS")
pdp_gvt <- pdp::partial(resub_farmer_vi,pred.var = "gvt_prog")
saveRDS(pdp_gvt, "./results/ranger-pdp/gvt_prog.RDS")
```

###########################
# 3.0 Reduced RFs
###########################

### 3.1.1 Spatiotemporal + climate covariates RF using ranger defaults, and 50 runs of 5-fold cross validation.
```{r}
sp_cl_rf <- bio_rf_cv %>% 
  select(YIELD, YEAR, lon, lat, PERC_IRR, GDD, BV2, BV4, BV8, BV9, BV15, BV18, BV19, TP) 

 infill_set <- merge(truetest, county_join, by = "GEOID")
infill_set <- infill_set %>% 
    select(YEAR, lon, lat, PERC_IRR, GDD, BV2, BV4, BV8, BV9, BV15, BV18, BV19, TP) 

set.seed(1234)   
for(iter in 1:50){
  cat(paste('iter = ', iter, ':: '))
  
  groups <- sample(rep(1:5, length.out = nrow(sp_cl_rf)))
  preds <- vector("numeric", nrow(sp_cl_rf)) - 1
  infill <- vector("numeric", nrow(infill_set)) - 1
  
  for(i in 1:5){
    train <- sp_cl_rf[groups != i, ]
    test <- sp_cl_rf[groups == i, ]
    
    tfit <- ranger::ranger(YIELD ~ ., 
                           train, 
                           importance = "permutation")
    preds[groups == i] <- predict(tfit, test)$predictions
    
  infill <- predict(tfit, infill_set, type = "response")$predictions
  
  }
     preds
     infill

    saveRDS(preds, paste0('./results/ranger-preds/sp_cl_RFpredscv_',iter,'.RDS'))
    saveRDS(infill, paste0('./results/ranger-infill/reduced/infill_',iter,'.RDS'))
  }

# build full list of files and bring them into the R environment
sp_cl_cv <- list.files(path = "./results/ranger-preds/",
                    pattern = "sp_cl_RFpredscv_", full.names = T, all.files = T) 

sp_cl_cv <- purrr::map(sp_cl_cv, readRDS)

sp_cl_cv_df <- as.data.frame(sp_cl_cv)

names <- c()
for(i in 1:50){
  names[i] <- c(paste0("preds_",i))
}

colnames(sp_cl_cv_df) <- c(names)
saveRDS(sp_cl_cv_df, "./results/sp_cl_preds.RDS")

sp_cl_preds <-readRDS("./results/sp_cl_preds.RDS")
sp_cl_cvpreds <- cbind(geoid_bio,sp_cl_preds)

sp_cl_cvpreds <- sp_cl_cvpreds %>% 
  select(GEOID,YIELD,YEAR,22:71) 

sp_cl_cvpreds$average_prediction = apply(sp_cl_cvpreds[,4,53], 1, mean)
sp_cl_cvpreds$median_prediction = apply(sp_cl_cvpreds[,4,53], 1, median)

sp_cl_cvpreds <- sp_cl_cvpreds %>% 
  mutate(error = YIELD - average_prediction)
saveRDS(sp_cl_cvpreds, "./results/sp_cl_cvpreds_ave.RDS")

# performance on verage
  RMSE <- caret::RMSE(sp_cl_cvpreds$average_prediction, sp_cl_cvpreds$YIELD)
  R2 <- 1 - (sum((sp_cl_cvpreds$YIELD - sp_cl_cvpreds$average_prediction)^2) / sum((sp_cl_cvpreds$YIELD - mean(sp_cl_cvpreds$YIELD))^2))
  
  # build argument to feed save, below
  list <- list("RMSE" = RMSE, "R2" = R2)
  print(list)
```

## 3.2.2 Spatiotemporal + climate covariates RF using ranger defaults, resubstitution for Variable Importance
```{r}
set.seed(1234)
resub_reduced_vi <- ranger(formula          = YIELD ~ ., 
               data             = sp_cl_rf, 
               num.trees        = 2000,
               replace = TRUE,
               importance       = "permutation")

  imp <- as.data.frame(resub_reduced_vi$variable.importance)
  imp$Variable <- row.names(imp)
  colnames(imp) <- c("VI", "VAR")
  farmer_imp <- imp
  
  saveRDS(imp, file = paste0('./results/ranger-imp/reduced_resub_RFimp.RDS'))
  
# Partial dependence, taken from the first iteration of ranger, above
pdp_irr <- pdp::partial(resub_reduced_vi,pred.var = "PERC_IRR")
saveRDS(pdp_irr, "./results/ranger-pdp/irr-red.RDS")
pdp_gdd <- pdp::partial(resub_reduced_vi,pred.var = "GDD")
saveRDS(pdp_gdd, "./results/ranger-pdp/GDD-red.RDS")
pdp_bv2 <- pdp::partial(resub_reduced_vi,pred.var = "BV2")
saveRDS(pdp_bv2, "./results/ranger-pdp/BV2-red.RDS")
pdp_lon <- pdp::partial(resub_reduced_vi,pred.var = "lon")
saveRDS(pdp_lon, "./results/ranger-pdp/lon-red.RDS")
pdp_lat <- pdp::partial(resub_reduced_vi,pred.var = "lat")
saveRDS(pdp_lat, "./results/ranger-pdp/lat-red.RDS")
pdp_year <- pdp::partial(resub_reduced_vi,pred.var = "YEAR")
saveRDS(pdp_year, "./results/ranger-pdp/year-red.RDS")
pdp_bv9 <- pdp::partial(resub_reduced_vi,pred.var = "BV9")
saveRDS(pdp_bv9, "./results/ranger-pdp/BV9-red.RDS")
pdp_bv4 <- pdp::partial(resub_reduced_vi,pred.var = "BV4")
saveRDS(pdp_bv4, "./results/ranger-pdp/BV4-red.RDS")
pdp_bv18 <- pdp::partial(resub_reduced_vi,pred.var = "BV18")
saveRDS(pdp_bv18, "./results/ranger-pdp/BV18-red.RDS")
pdp_bv19 <- pdp::partial(resub_reduced_vi,pred.var = "BV19")
saveRDS(pdp_bv19, "./results/ranger-pdp/BV19-red.RDS")
pdp_TP <- pdp::partial(resub_reduced_vi,pred.var = "TP")
saveRDS(pdp_TP, "./results/ranger-pdp/TP-red.RDS")
pdp_bv15 <- pdp::partial(resub_reduced_vi,pred.var = "BV15")
saveRDS(pdp_bv15, "./results/ranger-pdp/BV15-red.RDS")
pdp_bv8 <- pdp::partial(resub_reduced_vi,pred.var = "BV8")
saveRDS(pdp_bv8, "./results/ranger-pdp/BV8-red.RDS")
```

###########################
# 4.0 Infill 
###########################

## 4.1.1 Infill missing county-year yield in all counties reporting at least one year of yields between 2008 and 2018.
```{r}
library(tidyverse)
library(matrixStats)
# build full list of files and bring them into the R environment
infill_preds <- list.files(path = "./results/ranger-infill/reduced",
                    pattern = "infill_", full.names = T, all.files = T) 

infill_preds <- purrr::map(infill_preds, readRDS)

infill_preds_df <- as.data.frame(infill_preds)

names <- c()
for(i in 1:50){
  names[i] <- c(paste0("iter_",i))
}

colnames(infill_preds_df) <- c(names)

infill_set <- merge(truetest, county_join, by = "GEOID")
infill_preds_df <- cbind(infill_set,infill_preds_df)

infill_preds_df <- infill_preds_df %>% 
  select(GEOID,YEAR,86:135) 

infill_preds_df$average_prediction = apply(infill_preds_df[,3:52], 1, mean)
infill_preds_df$median_prediction = apply(infill_preds_df[,3:52], 1, median)

saveRDS(infill_preds_df, "./results/ranger-results/infill.RDS")
```

###########################
# 5.0 Naive infill - control
###########################

## 5.1.1 Infill missing county-year yield in all counties reporting at least one year of yields between 2008 and 2018 using naive imputation (median yield across reported years)
```{r}
corn_yield <- readRDS("./data/data-out/true-train.RDS")

corn_med <- corn_yield |>
  group_by(GEOID) |>
  summarize(n = n(),
            medyield = median(YIELD)) |>
  filter(n > 11)

corn_yield_compare <- corn_yield |>
  select(GEOID, YIELD) |>
  left_join(corn_med, by = "GEOID") |>
  drop_na() |>
  mutate(resid = YIELD - medyield)

sqrt(mean(corn_yield_compare$resid^2))

# n = 1, 25.74551
# n = 2, 25.81995
# n = 3, 25.82938 
# n = 4, 25.88753
# n = 5, 25.84599
# n = 6, 25.86363
# n = 7, 25.92752
# n = 8, 25.88558
# n = 9, 25.86005
# n = 10, 25.63954
# Our model improves prediction accuracy by over 25% compared to naive imputation (infilling with the median county yield across years, RMSE = 25.6-25.9 bushels/acre).
```

