---
title: "Corn Yield Random Forest"
author: "Britta Schumacher"
date: "Last updated: `r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    theme: yeti
    toc: yes
    toc_float: true
    code_folding: hide
---

# Bring in the data, clean it up, and run the model on the training set

```{r message = FALSE, warning = FALSE}
library(randomForest)
library(tidyverse)
library(ggplot2)
library(caret)
library(ie2misc)
library(MLmetrics)
library(ranger)
library(pdp)

# pull in TRUE train data; all data with recorded yield
corn_yield <- readRDS("./data/yieldRF.RDS")

# remove ID variables that aren't included in the model, GEOID
yield_RF <- corn_yield %>% dplyr::select(-c(GEOID))

# specify qualitative variables that are factors
yield_RF$YEAR <- as.factor(yield_RF$YEAR)
yield_RF$FRR <- as.factor(yield_RF$FRR)

```

# Initial Biophysical RF with classic randomForest() implementation

Default parameters ~ mtry = 3, ntree = 500
```{r}
set.seed(1234) 
random_rn <- sample(nrow(yield_RF), ceiling(nrow(yield_RF)*.25)) 
train_fullset <- yield_RF[-random_rn,] 
test_fullset <- yield_RF[random_rn,] 

# biophysical
train <- train_fullset %>% select(-c(29:39))
test <- test_fullset %>% select(-c(29:39))

# biophysical
rf_yield <- randomForest(YIELD ~ ., data = train)
```

# Now let's predict on the test set
```{r}
preds <- predict(rf_yield, test, type = "response")
test$PREDICTIONS <- preds
head(test %>% dplyr::select(PREDICTIONS, YIELD))
```

# How well did our model do?
```{r}
MSE <- mean((test$YIELD - test$PREDICTIONS)^2)
print(MSE)
RMSE <- caret::RMSE(test$PREDICTIONS, test$YIELD)
print(RMSE)
R2 <- 1 - (sum((test$YIELD - test$PREDICTIONS)^2) / sum((test$YIELD - mean(test$YIELD))^2))
print(R2)
pR2 <- 1 - MSE / var(test$YIELD)
print(pR2)
mae <- mae(test$PREDICTIONS, test$YIELD)
mae
mape <- MAPE(test$PREDICTIONS, test$YIELD)
mape
```

# What are the most important variables?
```{r}
imp <- as.data.frame(varImpPlot(rf_yield))
```

# Nicer visualization
```{r}
imp$varnames <- rownames(imp) # row names to column
imp$varfull <- c("Year", "Shannon's Diversity Index", "Growing degree days", "Total precipitation", "Mean diurnal range", "Temperature seasonality", "Mean temperature of the warmest quarter", "Mean temperature of the driest quarter", "Precipitation seasonality", "Precipitation of the warmest quarter", "Precipitation of the coldest quarter", "Slope", "Elevation", "Subsoil pH", "Topsoil calcium carbonate", "Topsoil gypsum", "Topsoil cation exchange capacity ~ clay", "Topsoil cation exchange capacity ~ soil", "Topsoil sodicity", "Topsoil gravel content", "Topsoil organic carbon", "Topsoil reference bulk density", "Topsoil silt fraction", "Topsoil salinity", "Topsoil sand fraction", "Irrigation", "Farm resource region")

ggplot(imp, aes(x=reorder(varfull, IncNodePurity), y=IncNodePurity)) + 
  geom_point() +
  geom_segment(aes(x=varfull,xend=varfull,y=0,yend=IncNodePurity)) +
  ylab("Increase in node purity") +
  xlab("") +
  coord_flip() +
  theme_minimal()
```

# Reduced RF - top 19 most important variables (threshold made sense because it includes climate, topo, and the top three important soil characteristics based on expert feedback: T_CEC, T_OC, S_PH)
```{r}
# remove variables that contributed least to the full model
yield_RF_reduced <- yield_RF %>% 
  dplyr::select(YEAR,YIELD,PERC_IRR,FRR,GDD,BV2,BV18,SDI_CDL_AG,BV9,BV4,TP,ELEVATION,S_PH_H2O,SLOPE,BV8,BV19,T_CEC_SOIL,BV15,T_REF_BULK_DENSITY,T_OC)

train <- train %>%  dplyr::select(YEAR,YIELD,PERC_IRR,FRR,GDD,BV2,BV18,SDI_CDL_AG,BV9,BV4,TP,ELEVATION,S_PH_H2O,SLOPE,BV8,BV19,T_CEC_SOIL,BV15,T_REF_BULK_DENSITY,T_OC)

test <- test %>%  dplyr::select(YEAR,YIELD,PERC_IRR,FRR,GDD,BV2,BV18,SDI_CDL_AG,BV9,BV4,TP,ELEVATION,S_PH_H2O,SLOPE,BV8,BV19,T_CEC_SOIL,BV15,T_REF_BULK_DENSITY,T_OC)

rf_yield_reduced <- randomForest(YIELD ~ ., data = train)
```

# Now let's predict on the test set
```{r}
preds_red <- predict(rf_yield_reduced, test, type = "response")
test$PREDICTIONS <- preds_red
head(test %>% dplyr::select(PREDICTIONS, YIELD))
#saveRDS(test, file = './results/RFpreds_red.RDS')
```

# How well did our model do?
```{r}
MSE_red <- mean((test$YIELD - test$PREDICTIONS)^2)
print(MSE_red)
RMSE_red <- caret::RMSE(test$PREDICTIONS, test$YIELD)
print(RMSE_red)
R2_red <- 1 - (sum((test$YIELD - test$PREDICTIONS)^2) / sum((test$YIELD - mean(test$YIELD))^2))
print(R2_red)
pR2_red <- 1 - MSE_red / var(test$YIELD)
print(pR2_red)
mae_red <- mae(test$PREDICTIONS, test$YIELD)
mae_red
mape_red <- MAPE(test$PREDICTIONS, test$YIELD)
mape_red
```

Metrics barely change from full to reduced RF.

# What are the most important variables?
```{r}
imp_red <- as.data.frame(varImpPlot(rf_yield_reduced))
```

# Nicer visualization
```{r}
imp_red$varnames <- rownames(imp_red) # row names to column
imp_red$varfull <- c("Year", "Irrigation", "Farm resource region", "Growing Degree Days", "Mean diurnal range", "Precipitation of the warmest quarter", "Shannon's Diversity Index", "Mean temperature of the driest quarter", "Temperature seasonality", "Elevation", "Total precipitation", "Slope", "Mean temperature of the wettest quarter", "Precipitation of the coldest quarter", "Subsoil pH", "Precipitation seasonality",  "Topsoil cation exchange capacity ~ soil", "Topsoil reference bulk density", "Topsoil organic carbon")

imp_red <- imp_red %>%  mutate(Prop = IncNodePurity/sum(IncNodePurity)*100)

#saveRDS(imp_red, file = './results/RFimp_red.RDS')

imp_plot <- ggplot(imp_red, aes(x=reorder(varfull, IncNodePurity), y=IncNodePurity)) + 
  geom_point() +
  geom_segment(aes(x=varfull,xend=varfull,y=0,yend=IncNodePurity)) +
  ylab("Increase in node purity") +
  xlab("") +
  coord_flip() +
  theme_minimal()

imp_plot

#ggsave(imp_plot, file = './viz/RFimpplot_red.png', dpi = 300, width = 7, height = 7)
```

########################################################################################################################################################################################################################################################################################################################

# Biophysical RFs

########################################################################################################################################################################################################################################################################################################################

## Build training and test sets for: all data, pruned biophysical data, and pruned farm(er) data
```{r train and test}
# pull in TRUE train data; all data with recorded yield
corn_yield <- readRDS("./data/yieldRF.RDS")
corn_bioph <- corn_yield %>% select(GEOID,YEAR,YIELD,PERC_IRR,FRR,GDD,BV2,BV18,SDI_CDL_AG,BV9,BV4,TP,ELEVATION,S_PH_H2O,SLOPE,BV8,BV19,T_CEC_SOIL,BV15,T_REF_BULK_DENSITY,T_OC)
yield_RF <- corn_yield %>% dplyr::select(-c(GEOID))

# specify qualitative variables that are factors
yield_RF$YEAR <- as.factor(yield_RF$YEAR)
yield_RF$FRR <- as.factor(yield_RF$FRR)

##########################################################################################################################################################################################################################################

# build training and test sets used in each iteration of the RF, below
# Create training (75%) and test (25%) sets for our corn yield data.
# Use set.seed for reproducibility
set.seed(1234) 
random_rn <- sample(nrow(yield_RF), ceiling(nrow(yield_RF)*.25)) 
train_fullset <- yield_RF[-random_rn,] 
test_fullset <- yield_RF[random_rn,] 

# subset for only biophysical variables
train <- train_fullset %>% select(YEAR,YIELD,PERC_IRR,FRR,GDD,BV2,BV18,SDI_CDL_AG,BV9,BV4,TP,ELEVATION,S_PH_H2O,SLOPE,BV8,BV19,T_CEC_SOIL,BV15,T_REF_BULK_DENSITY,T_OC)
test <- test_fullset %>% select(YEAR,YIELD,PERC_IRR,FRR,GDD,BV2,BV18,SDI_CDL_AG,BV9,BV4,TP,ELEVATION,S_PH_H2O,SLOPE,BV8,BV19,T_CEC_SOIL,BV15,T_REF_BULK_DENSITY,T_OC)

# subset for biophysical AND farm(er) variables
farmer_train <- train_fullset %>% select(YEAR,YIELD,PERC_IRR,FRR,GDD,BV2,BV18,SDI_CDL_AG,BV9,BV4,TP,ELEVATION,S_PH_H2O,SLOPE,BV8,BV19,T_CEC_SOIL,BV15,T_REF_BULK_DENSITY,T_OC,29:39)
farmer_test <- test_fullset %>% select(YEAR,YIELD,PERC_IRR,FRR,GDD,BV2,BV18,SDI_CDL_AG,BV9,BV4,TP,ELEVATION,S_PH_H2O,SLOPE,BV8,BV19,T_CEC_SOIL,BV15,T_REF_BULK_DENSITY,T_OC,29:39)

# bring in true test
truetest <- readRDS("./data/true-test-infillobs.RDS")

truetest$YEAR <- as.factor(truetest$YEAR)
truetest$FRR <- as.factor(truetest$FRR)

# subset for only biophysical variables
infill_bioph <- truetest %>% 
  dplyr::select(YEAR,YIELD,PERC_IRR,FRR,GDD,BV2,BV18,SDI_CDL_AG,BV9,BV4,TP,ELEVATION,S_PH_H2O,SLOPE,BV8,BV19,T_CEC_SOIL,BV15,T_REF_BULK_DENSITY,T_OC)

# subset for biophysical AND farm(er) variables
infill_farmer <- truetest %>% select(YEAR,YIELD,PERC_IRR,FRR,GDD,BV2,BV18,SDI_CDL_AG,BV9,BV4,TP,ELEVATION,S_PH_H2O,SLOPE,BV8,BV19,T_CEC_SOIL,BV15,T_REF_BULK_DENSITY,T_OC,72, 74:83)
```

########################################################################################################################################################################################################################################################################################################################

# Biophysical RFs

########################################################################################################################################################################################################################################################################################################################

## Iterations on biophysical models tuned with randomForests()
```{r}
set.seed(1234)

for (iter in 1:100){
  cat(paste('iter = ', iter, ':: '))
  
  # train the model
  rf <- randomForest(YIELD ~ ., data = train, mtry = 12, ntree = 2000)
  
  # test the model
  preds <- predict(rf, test, type = "response")
  test$PREDICTIONS <- preds
  
  # infill 
  infill <- predict(rf, infill_bioph, type = "response")
  infill_bioph$PREDICTIONS <- infill

  # performance on test set
  RMSE <- caret::RMSE(test$PREDICTIONS, test$YIELD)
  R2 <- 1 - (sum((test$YIELD - test$PREDICTIONS)^2) / sum((test$YIELD - mean(test$YIELD))^2))
  MAE <- mae(test$PREDICTIONS, test$YIELD)
  MAPE <- MAPE(test$PREDICTIONS, test$YIELD)
  
  # build argument to feed save, below
  list <- list("RMSE" = RMSE, "R2" = R2, "MAE" = MAE, "MAPE" = MAPE, "var_exp" = rf)
  print(list)
  
  # variable importance
  imp <- as.data.frame(varImpPlot(rf))
  colnames(imp)[1] <- paste0('IncPurity_',iter)
  imp$varnames <- rownames(imp) # row names to column

    # save .RDS's
  saveRDS(test, file = paste0('./results-preds/bio_RFpreds_',iter,'.RDS'))
  saveRDS(imp, file = paste0('./results-imp/bio_RFimp_',iter,'.RDS'))
  saveRDS(infill_bioph, file = paste0('./results-infill/bio_infill_',iter,'.RDS'))
}

  
```

## Take the average of the results for n = 100 RFs
```{r}
library(tidyverse)
# build full list of files and bring them into the R environment
prediction <- list.files(path="results-preds", 
                         pattern=".RDS", full.names=T, all.files=T) %>% 
  map_dfr(readRDS) 

prediction <- merge(prediction, corn_bioph, by = c("YEAR","YIELD","PERC_IRR","FRR","GDD","BV2","BV18","SDI_CDL_AG","BV9","BV4","TP","ELEVATION","S_PH_H2O","SLOPE","BV8","BV19","T_CEC_SOIL","BV15","T_REF_BULK_DENSITY","T_OC"))

library(tidyverse)
prediction_summary <- prediction %>% 
  mutate(FRR = as.numeric(FRR)) %>% 
  dplyr::group_by(GEOID, YEAR) %>% 
  summarise(across(everything(), list(mean)))

# overall performance
# performance on test set
  RMSE <- caret::RMSE(prediction_summary$PREDICTIONS, prediction_summary$YIELD)
  R2 <- 1 - (sum((prediction_summary$YIELD - prediction_summary$PREDICTIONS)^2) / sum((prediction_summary$YIELD - mean(prediction_summary$YIELD))^2))
  MAE <- mae(prediction_summary$PREDICTIONS, prediction_summary$YIELD)
  MAPE <- MAPE(prediction_summary$PREDICTIONS, prediction_summary$YIELD)
  
  # build argument to feed save, below
  list <- list("RMSE" = RMSE, "R2" = R2, "MAE" = MAE, "MAPE" = MAPE, "var_exp" = rf)
  print(list)
```

# Biophysical RF using optimal ranger from tune-RF

ntree = 2000, mtry = 7, node size = 4, sample size = 0.800 ~ OOB RMSE = 17.54877
```{r}
detach(package:dplyr)
set.seed(1234)

for (iter in 1:100){
  cat(paste('iter = ', iter, ':: '))
  
  # train the model
  rf <- ranger(formula          = YIELD ~ ., 
               data             = train, 
               num.trees        = 2000,
               mtry             = 7, 
               min.node.size    = 4,
               sample.fraction  = 0.8,
               importance       = "permutation")
  
  # test the model
  preds <- predict(rf, data = test)
  preds <- as.data.frame(preds$predictions)
  colnames(preds) <- "PREDS"
  test <- cbind(test, preds) 
  
  # infill 
  infill <- predict(rf, infill_bioph, type = "response")
  infill <- as.data.frame(infill$predictions)
  colnames(infill) <- "INFILL"
  infill_bioph <- cbind(infill_bioph, infill) 

  # performance on test set
  RMSE <- caret::RMSE(test$PREDS, test$YIELD)
  R2 <- 1 - (sum((test$YIELD - test$PREDS)^2) / sum((test$YIELD - mean(test$YIELD))^2))
  MAE <- mae(test$PREDS, test$YIELD)
  MAPE <- MAPE(test$PREDS, test$YIELD)
  
  # build argument to feed save, below
  list <- list("RMSE" = RMSE, "R2" = R2, "MAE" = MAE, "MAPE" = MAPE, "var_exp" = rf)
  print(list)
  
  # variable importance
  imp <- as.data.frame(rf$variable.importance)
  imp$Variable <- row.names(imp)
  colnames(imp) <- c("VI", "VAR")
  ranger_imp <- imp
  
  # partial dependence
  #pdp <- partial(rf, c("PERC_IRR","GDD","BV2","SDI_CDL_AG","S_PH_H2O","BV18"))
  
  # save .RDS's
  saveRDS(test, file = paste0('./results/ranger-preds/bio_RFpreds_',iter,'.RDS'))
  saveRDS(imp, file = paste0('./results/ranger-imp/bio_RFimp_',iter,'.RDS'))
  #saveRDS(pdp, file = paste0('./results/ranger-pdp/bio_RFpdp_',iter,'.RDS'))
  saveRDS(infill_bioph, file = paste0('./results/ranger-infill/bio_infill_',iter,'.RDS'))

}

# Partial dependence, taken from the first iteration of ranger, above
pdp_irr <- pdp::partial(rf,pred.var = "PERC_IRR")
saveRDS(pdp_irr, "./results/ranger-pdp/irr.RDS")
pdp_gdd <- pdp::partial(rf,pred.var = "GDD")
saveRDS(pdp_gdd, "./results/ranger-pdp/GDD.RDS")
pdp_bv2 <- pdp::partial(rf,pred.var = "BV2")
saveRDS(pdp_bv2, "./results/ranger-pdp/BV2.RDS")
pdp_dsi <- pdp::partial(rf,pred.var = "SDI_CDL_AG")
saveRDS(pdp_dsi, "./results/ranger-pdp/SDI.RDS")
pdp_ph <- pdp::partial(rf,pred.var = "S_PH_H2O")
saveRDS(pdp_ph, "./results/ranger-pdp/pH.RDS")
pdp_bv18 <- pdp::partial(rf,pred.var = "BV18")
saveRDS(pdp_bv18, "./results/ranger-pdp/BV18.RDS")
```

## Take the average of the performance results for *n* = 100 RFs
```{r}
library(tidyverse)
# build full list of files and bring them into the R environment
bioph <- readRDS("./results/ranger-preds/bio_RFpreds_100.RDS")

names(bioph)[21:ncol(bioph)] <- unlist(mapply(function(x,y) paste(x, seq(1,y), sep="_"), "PREDS", 100))

bioph <- bioph %>% pivot_longer(cols = c(21:120), names_to = "PRED_NUM", values_to = "PREDS") %>% select(-PRED_NUM)

prediction_bioph <- merge(bioph, corn_bioph, by = c("YEAR","YIELD","PERC_IRR","FRR","GDD","BV2","BV18","SDI_CDL_AG","BV9","BV4","TP","ELEVATION","S_PH_H2O","SLOPE","BV8","BV19","T_CEC_SOIL","BV15","T_REF_BULK_DENSITY","T_OC"))

prediction_bioph <- prediction_bioph %>% select(GEOID, everything())

prediction_bioph_summary <- prediction_bioph %>% 
  #mutate(FRR = as.numeric(FRR)) %>% 
  dplyr::group_by(GEOID, YEAR, YIELD) %>% 
  summarize(average_prediction = ave(PREDS)) %>% 
  distinct() %>% 
  mutate(error = YIELD - average_prediction)

saveRDS(prediction_bioph_summary, "./data/data-out/ensemble_bioph_preds.RDS")

# overall performance
# performance on test set
  b_RMSE <- caret::RMSE(prediction_bioph_summary$average_prediction, prediction_bioph_summary$YIELD)
  b_R2 <- 1 - (sum((prediction_bioph_summary$YIELD - prediction_bioph_summary$average_prediction)^2) / sum((prediction_bioph_summary$YIELD - mean(prediction_bioph_summary$YIELD))^2))
  b_MAE <- mae(prediction_bioph_summary$average_prediction, prediction_bioph_summary$YIELD)
  b_MAPE <- MAPE(prediction_bioph_summary$average_prediction, prediction_bioph_summary$YIELD)
  
  # build argument to feed save, below
  bioph_list <- list("RMSE" = b_RMSE, "R2" = b_R2, "MAE" = b_MAE, "MAPE" = b_MAPE)
  print(bioph_list)
```

## Take the average of the variable importance results for *n* = 100 RFs
```{r}
# build full list of files and bring them into the R environment
bioph_imp <- list.files(path = "./results/ranger-imp/",
                    pattern = "bio", full.names = T, all.files = T) %>% 
  map_dfr(readRDS) %>% 
  group_by(VAR) %>% 
  summarise(ave_imp = mean(VI),
            sd_imp = sd(VI)) %>% 
  mutate(VAR = as.factor(VAR))

# variable importance plo
bioph_imp$VAR_NAME <- c("Precipitation Seasonality", "Precipitation of the warmest quarter", "Precipitation of the coldest quarter", "Mean diurnal range", "Temperature seasonality", "Mean temperature of the wettest quarter", "Mean temperature of the driest quarter", "Elevation", "Farm Resource Region", "Growing degree days", "Percent irrigated acreage", "Subsoil pH", "Shannon's Diversity Index", "Slope", "Topsoil cation exchange capacity", "Topsoil organic carbon", "Topsoil reference bulk density", "Total precipitation", "Year")

bioph_imp <- bioph_imp %>%  mutate(Prop = ave_imp/sum(ave_imp)*100)

#saveRDS(imp_red, file = './results/RFimp_red.RDS')

bioph_imp_plot <- ggplot(bioph_imp, aes(x=reorder(VAR_NAME, ave_imp), y=ave_imp)) + 
  geom_point() +
  geom_segment(aes(x=VAR_NAME,xend=VAR_NAME,y=0,yend=ave_imp)) +
  ylab("Increase in node purity") +
  xlab("") +
  coord_flip() +
  theme_minimal()

bioph_imp_plot
```


### Biophysical RF using optimal ranger from tune-RF & all available covariates - to compare model performance on full v. subset
```{r}
bio_full <- readRDS("./data/all-available-BIOPH-attributes.RDS")

bio_full_train <- merge(train, bio_full, by = c("YEAR","YIELD","PERC_IRR","FRR","GDD","BV2","BV18","SDI_CDL_AG","BV9","BV4","TP","ELEVATION","S_PH_H2O","SLOPE","BV8","BV19","T_CEC_SOIL","BV15","T_REF_BULK_DENSITY","T_OC"))

bio_full_train <- bio_full_train %>% select(!GEOID)

bio_full_test <- merge(test, bio_full, by = c("YEAR","YIELD","PERC_IRR","FRR","GDD","BV2","BV18","SDI_CDL_AG","BV9","BV4","TP","ELEVATION","S_PH_H2O","SLOPE","BV8","BV19","T_CEC_SOIL","BV15","T_REF_BULK_DENSITY","T_OC"))

bio_full_test <- bio_full_test %>% select(!GEOID)

set.seed(1234)

for (iter in 1:10){
  cat(paste('iter = ', iter, ':: '))
  # train the model
  rf <- ranger(formula          = YIELD ~ ., 
               data             = bio_full_train, 
               num.trees        = 2000,
               mtry             = 19, 
               min.node.size    = 4,
               sample.fraction  = 0.8,
               importance       = "permutation")
  
  # test the model
  preds <- predict(rf, data = bio_full_test)
  preds <- as.data.frame(preds$predictions)
  colnames(preds) <- "PREDS"
  test <- cbind(bio_full_test, preds) 

  saveRDS(test, file = paste0('./results/ranger-preds/bio_full_RFpreds_',iter,'.RDS'))
  
}

# build full list of files and bring them into the R environment
bio_full <- list.files(path = "./results/ranger-preds/",
                    pattern = "bio_full", full.names = T, all.files = T) %>% 
  map_dfr(readRDS) 

prediction_full_bio <- merge(bio_full, corn_bioph, by = c("YEAR","YIELD","PERC_IRR","FRR","GDD","BV2","BV18","SDI_CDL_AG","BV9","BV4","TP","ELEVATION","S_PH_H2O","SLOPE","BV8","BV19","T_CEC_SOIL","BV15","T_REF_BULK_DENSITY","T_OC"))

# build prediction data.frame
prediction_full_bio_summary <- prediction_full_bio %>% 
  #mutate(FRR = as.numeric(FRR)) %>% 
  group_by(GEOID, YEAR, YIELD) %>% 
  summarize(average_prediction = ave(PREDS)) %>% 
  distinct() %>% 
  mutate(error = YIELD - average_prediction)

#saveRDS(prediction_full_farm_summary, "./data/data-out/ensemble_full_farm_preds.RDS")

# overall performance
  fb_RMSE <- caret::RMSE(prediction_full_bio_summary$average_prediction, prediction_full_bio_summary$YIELD)
  fb_R2 <- 1 - (sum((prediction_full_bio_summary$YIELD - prediction_full_bio_summary$average_prediction)^2) / sum((prediction_full_bio_summary$YIELD - mean(prediction_full_bio_summary$YIELD))^2))
  fb_MAE <- mae(prediction_full_bio_summary$average_prediction, prediction_full_bio_summary$YIELD)
  fb_MAPE <- MAPE(prediction_full_bio_summary$average_prediction, prediction_full_bio_summary$YIELD)

  full_bio_list <- list("RMSE" = fb_RMSE, "R2" = fb_R2, "MAE" = fb_MAE, "MAPE" = fb_MAPE)
  print(full_bio_list)
```

########################################################################################################################################################################################################################################################################################################################

# Farm(er) RFs

########################################################################################################################################################################################################################################################################################################################

# Farm(er) RF using optimal ranger from tune-RF

ntree = 2000, mtry = 19, node size = 4, sample size = 0.800, OOB RMSE = 17.53468
```{r}
set.seed(1234)

for (iter in 1:1){
  cat(paste('iter = ', iter, ':: '))
  
  # train the model
  rf <- ranger(formula          = YIELD ~ ., 
               data             = farmer_train, 
               num.trees        = 2000,
               mtry             = 19, 
               min.node.size    = 4,
               sample.fraction  = 0.8,
               importance       = "permutation")
  
  # test the model
  preds <- predict(rf, data = farmer_test)
  preds <- as.data.frame(preds$predictions)
  colnames(preds) <- "PREDS"
  test <- cbind(farmer_test, preds) 
  
  # infill 
  infill <- predict(rf, infill_farmer, type = "response")
  infill <- as.data.frame(infill$predictions)
  colnames(infill) <- "INFILL"
  infill_farmer <- cbind(infill_farmer, infill) 

  # performance on test set
  RMSE <- caret::RMSE(test$PREDS, test$YIELD)
  R2 <- 1 - (sum((test$YIELD - test$PREDNS)^2) / sum((test$YIELD - mean(test$YIELD))^2))
  MAE <- mae(test$PREDS, test$YIELD)
  MAPE <- MAPE(test$PREDS, test$YIELD)
  
  # build argument to feed save, below
  list <- list("RMSE" = RMSE, "R2" = R2, "MAE" = MAE, "MAPE" = MAPE, "var_exp" = rf)
  print(list)
  
  # variable importance
  imp <- as.data.frame(rf$variable.importance)
  imp$Variable <- row.names(imp)
  colnames(imp) <- c("VI", "VAR")
  ranger_imp <- imp
  
  # save .RDS's
  saveRDS(test, file = paste0('./results/ranger-preds/farmer_RFpreds_',iter,'.RDS'))
  saveRDS(imp, file = paste0('./results/ranger-imp/farmer_RFimp_',iter,'.RDS'))
  saveRDS(infill_farmer, file = paste0('./results/ranger-infill/farmer_infill_',iter,'.RDS'))

}

# Partial dependence, taken from the first iteration of ranger, above
pdp_fert <- pdp::partial(rf,pred.var = "fert")
saveRDS(pdp_fert, "./results/ranger-pdp/fert.RDS")
pdp_chem <- pdp::partial(rf,pred.var = "chem")
saveRDS(pdp_chem, "./results/ranger-pdp/chem.RDS")
pdp_corn <- pdp::partial(rf,pred.var = "perc_corn")
saveRDS(pdp_corn, "./results/ranger-pdp/corn_acreage.RDS")
pdp_insur <- pdp::partial(rf,pred.var = "insur_acres")
saveRDS(pdp_insur, "./results/ranger-pdp/insur.RDS")
pdp_gvt <- pdp::partial(rf,pred.var = "gvt_prog")
saveRDS(pdp_gvt, "./results/ranger-pdp/gvt_prog.RDS")
```

## Take the average of the results for n = 100 RFs
```{r}
library(tidyverse)
# build full list of files and bring them into the R environment
farm <- list.files(path = "./results/ranger-preds/",
                    pattern = "farmer", full.names = T, all.files = T) %>% 
  map_dfr(readRDS) 

prediction_farm <- merge(farm, corn_bioph, by = c("YEAR","YIELD","PERC_IRR","FRR","GDD","BV2","BV18","SDI_CDL_AG","BV9","BV4","TP","ELEVATION","S_PH_H2O","SLOPE","BV8","BV19","T_CEC_SOIL","BV15","T_REF_BULK_DENSITY","T_OC"))

library(tidyverse)
prediction_farm_summary <- prediction_farm %>% 
  #mutate(FRR = as.numeric(FRR)) %>% 
  group_by(GEOID, YEAR, YIELD) %>% 
  summarize(average_prediction = ave(PREDS)) %>% 
  distinct() %>% 
  mutate(error = YIELD - average_prediction)

saveRDS(prediction_farm_summary, "./data/data-out/ensemble_farm_preds.RDS")

# overall performance
# performance on test set
  f_RMSE <- caret::RMSE(prediction_farm_summary$average_prediction, prediction_farm_summary$YIELD)
  f_R2 <- 1 - (sum((prediction_farm_summary$YIELD - prediction_farm_summary$average_prediction)^2) / sum((prediction_farm_summary$YIELD - mean(prediction_farm_summary$YIELD))^2))
  f_MAE <- mae(prediction_farm_summary$average_prediction, prediction_farm_summary$YIELD)
  f_MAPE <- MAPE(prediction_farm_summary$average_prediction, prediction_farm_summary$YIELD)
  
  # build argument to feed save, below
  farmer_list <- list("RMSE" = f_RMSE, "R2" = f_R2, "MAE" = f_MAE, "MAPE" = f_MAPE)
  print(farmer_list)
```
## Take the average of the variable importance results for *n* = 100 RFs
```{r}
# build full list of files and bring them into the R environment
farmer_imp <- list.files(path = "./results/ranger-imp/",
                    pattern = "farm", full.names = T, all.files = T) %>% 
  map_dfr(readRDS) %>% 
  group_by(VAR) %>% 
  summarise(ave_imp = mean(VI),
            sd_imp = sd(VI)) %>% 
  mutate(VAR = as.factor(VAR))

# variable importance plo
farmer_imp$VAR_NAME <- c("Precipitation Seasonality", "Precipitation of the warmest quarter", "Precipitation of the coldest quarter", "Mean diurnal range", "Temperature seasonality", "Mean temperature of the wettest quarter", "Mean temperature of the driest quarter", "Elevation", "Farm Resource Region", "Growing degree days", "Percent irrigated acreage", "Subsoil pH", "Shannon's Diversity Index", "Slope", "Topsoil cation exchange capacity", "Topsoil organic carbon", "Topsoil reference bulk density", "Total precipitation", "Year")

farmer_imp <- farmer_imp %>%  mutate(Prop = ave_imp/sum(ave_imp)*100)

#saveRDS(imp_red, file = './results/RFimp_red.RDS')

farmer_imp_plot <- ggplot(bioph_imp, aes(x=reorder(VAR_NAME, ave_imp), y=ave_imp)) + 
  geom_point() +
  geom_segment(aes(x=VAR_NAME,xend=VAR_NAME,y=0,yend=ave_imp)) +
  ylab("Increase in node purity") +
  xlab("") +
  coord_flip() +
  theme_minimal()

farmer_imp_plot
```

### Farm(er) RF using optimal ranger from tune-RF & all available covariates - to compare model performance on full v. subset
```{r}
farmer_full <- readRDS("./data/all-available-FARMER-attributes.RDS")

farmer_full_train <- merge(farmer_train, farmer_full, by = c("YEAR","YIELD","PERC_IRR","FRR","GDD","BV2","BV18","SDI_CDL_AG","BV9","BV4","TP","ELEVATION","S_PH_H2O","SLOPE","BV8","BV19","T_CEC_SOIL","BV15","T_REF_BULK_DENSITY","T_OC","chem", "fert","labor_expense","machinery","perc_corn","gvt_prog","insur_acres","exp","occup","tenant","acres_per_op"))

farmer_full_train <- farmer_full_train %>% select(!GEOID)

farmer_full_test <- merge(farmer_test, farmer_full, by = c("YEAR","YIELD","PERC_IRR","FRR","GDD","BV2","BV18","SDI_CDL_AG","BV9","BV4","TP","ELEVATION","S_PH_H2O","SLOPE","BV8","BV19","T_CEC_SOIL","BV15","T_REF_BULK_DENSITY","T_OC","chem", "fert","labor_expense","machinery","perc_corn","gvt_prog","insur_acres","exp","occup","tenant","acres_per_op"))

farmer_full_test <- farmer_full_test %>% select(!GEOID)

set.seed(1234)

for (iter in 1:10){
  cat(paste('iter = ', iter, ':: '))
  # train the model
  rf <- ranger(formula          = YIELD ~ ., 
               data             = farmer_full_train, 
               num.trees        = 2000,
               mtry             = 19, 
               min.node.size    = 4,
               sample.fraction  = 0.8,
               importance       = "permutation")
  
  # test the model
  preds <- predict(rf, data = farmer_full_test)
  preds <- as.data.frame(preds$predictions)
  colnames(preds) <- "PREDS"
  test <- cbind(farmer_full_test, preds) 

  saveRDS(test, file = paste0('./results/ranger-preds/farmer_full_RFpreds_',iter,'.RDS'))
  
}

# build full list of files and bring them into the R environment
farm_full <- list.files(path = "./results/ranger-preds/",
                    pattern = "farmer_full", full.names = T, all.files = T) %>% 
  map_dfr(readRDS) 

prediction_full_farm <- merge(farm_full, corn_bioph, by = c("YEAR","YIELD","PERC_IRR","FRR","GDD","BV2","BV18","SDI_CDL_AG","BV9","BV4","TP","ELEVATION","S_PH_H2O","SLOPE","BV8","BV19","T_CEC_SOIL","BV15","T_REF_BULK_DENSITY","T_OC"))

# build prediction data.frame
prediction_full_farm_summary <- prediction_full_farm %>% 
  #mutate(FRR = as.numeric(FRR)) %>% 
  group_by(GEOID, YEAR, YIELD) %>% 
  summarize(average_prediction = ave(PREDS)) %>% 
  distinct() %>% 
  mutate(error = YIELD - average_prediction)

#saveRDS(prediction_full_farm_summary, "./data/data-out/ensemble_full_farm_preds.RDS")

# overall performance
  ff_RMSE <- caret::RMSE(prediction_full_farm_summary$average_prediction, prediction_full_farm_summary$YIELD)
  ff_R2 <- 1 - (sum((prediction_full_farm_summary$YIELD - prediction_full_farm_summary$average_prediction)^2) / sum((prediction_full_farm_summary$YIELD - mean(prediction_full_farm_summary$YIELD))^2))
  ff_MAE <- mae(prediction_full_farm_summary$average_prediction, prediction_full_farm_summary$YIELD)
  ff_MAPE <- MAPE(prediction_full_farm_summary$average_prediction, prediction_full_farm_summary$YIELD)

  full_farmer_list <- list("RMSE" = ff_RMSE, "R2" = ff_R2, "MAE" = ff_MAE, "MAPE" = ff_MAPE)
  print(full_farmer_list)
```

## Take the average of the infill results for *n* = 100 biophysical RFs
```{r}
# build full list of files and bring them into the R environment
bioph_infill <- readRDS("./results/ranger-infill/bio_infill_100.RDS")

names(bioph_infill)[21:ncol(bioph_infill)] <- unlist(mapply(function(x,y) paste(x, seq(1,y), sep="_"), "PREDS", 100))

bioph_infill <- bioph_infill %>% pivot_longer(cols = c(21:120), names_to = "PRED_NUM", values_to = "PREDS") %>% select(-PRED_NUM)

infill <- readRDS("./data/true-test-infillobs.RDS")
bioph_infill <- merge(bioph_infill, infill, by = c("YEAR","PERC_IRR","FRR","GDD","BV2","BV18","SDI_CDL_AG","BV9","BV4","TP","ELEVATION","S_PH_H2O","SLOPE","BV8","BV19","T_CEC_SOIL","BV15","T_REF_BULK_DENSITY","T_OC"))

bioph_infill_summary <- bioph_infill %>% 
  #mutate(FRR = as.numeric(FRR)) %>% 
  dplyr::group_by(GEOID, YEAR) %>% 
  summarize(average_prediction = ave(PREDS)) %>% 
  distinct() 

saveRDS(bioph_infill_summary, "./data/data-out/ensemble_bioph_infill.RDS")
```

## Take the average of the infill results for *n* = 100 farm(er) RFs
```{r}
# build full list of files and bring them into the R environment
farmer_infill <- readRDS("./results/ranger-infill/farmer_infill_100.RDS")
farmer_infill <- farmer_infill[-c(32:33)]

names(farmer_infill)[32:ncol(farmer_infill)] <- unlist(mapply(function(x,y) paste(x, seq(1,y), sep="_"), "PREDS", 100))

farmer_infill <- farmer_infill %>% pivot_longer(cols = c(32:131), names_to = "PRED_NUM", values_to = "PREDS") %>% select(-PRED_NUM)

farmer_infill <- merge(farmer_infill, infill, by = c("YEAR","PERC_IRR","FRR","GDD","BV2","BV18","SDI_CDL_AG","BV9","BV4","TP","ELEVATION","S_PH_H2O","SLOPE","BV8","BV19","T_CEC_SOIL","BV15","T_REF_BULK_DENSITY","T_OC"))

farmer_infill_summary <- farmer_infill %>% 
  #mutate(FRR = as.numeric(FRR)) %>% 
  dplyr::group_by(GEOID, YEAR) %>% 
  summarize(average_prediction = ave(PREDS)) %>% 
  distinct() 

saveRDS(farmer_infill_summary, "./data/data-out/ensemble_farmer_infill.RDS")
```

## Compare biophysical and farm(er) predictions
```{r}
infill_diff <- merge(bioph_infill_summary, farmer_infill_summary, by = c("GEOID", "YEAR"))

colnames(infill_diff) <- c("GEOID", "YEAR", "BIOPH", "FARMER")

infill_diff <- infill_diff %>% 
  mutate(DIFF = BIOPH-FARMER)

saveRDS(infill_diff, "./data/data-out/ensemble_infill_diff.RDS")
```


#########################################################################################################################################################################################################################################

---

# Potential Trash Below

### Subset RFs by year
```{r}
# remove variables that contributed least to the full model
rf_year <- function(year) {
  
  #index
  index <- year
  
  # build data
  yield_RF <- yield_RF_reduced %>% 
  filter(YEAR == year) %>% 
  dplyr::select(-c(YEAR))
  
  # build training and test sets
  set.seed(1234) 
  random_rn <- sample(nrow(yield_RF), ceiling(nrow(yield_RF)*.25)) 
  train <- yield_RF[-random_rn,] 
  test <- yield_RF[random_rn,] 
  
  sum_stat <- test %>% 
    summarise(mean = mean(YIELD),
           median = median(YIELD),
           sd = sd(YIELD))
  
  # build RF on training data
  rf_yield <- randomForest(YIELD ~ ., data = train)
  rf_yield
  
  # build predictions on test set
  preds <- predict(rf_yield, test, type = "response")
  test$PREDICTIONS <- preds
  
  # build MSE/RMSE
  MSE <- mean((test$YIELD - test$PREDICTIONS)^2)
  RMSE <- caret::RMSE(test$PREDICTIONS, test$YIELD)
  R2 <- 1 - (sum((test$YIELD - test$PREDICTIONS)^2)/sum((test$YIELD - mean(test$YIELD))^2))
  pR2 <- 1 - MSE / var(test$YIELD)
  
  # build clean dataframe
  colnames(test)[1] <- paste0('YIELD_',index)
  colnames(test)[22] <- paste0('PREDS_',index)
  
  # importance plots
  imp <- as.data.frame(importance(rf_yield))
  imp$varnames <- rownames(imp) # row names to column
  
  imp_plot <- ggplot(imp, aes(x=reorder(varnames, IncNodePurity), y=IncNodePurity)) + 
  geom_point() +
  geom_segment(aes(x=varnames,xend=varnames,y=0,yend=IncNodePurity)) +
  ylab("Increase in node purity") +
  xlab("") +
  coord_flip() +
  theme_minimal()
  
  colnames(imp)[1] <- paste0('IncPurity_',index)
  
  # build argument to feed save, below
  list <- list("MSE" = MSE, "RMSE" = RMSE, "R2" = R2, "pR2" = pR2, "var_exp" = rf_yield)
  
  # return
  saveRDS(test, file = paste0('./results/RFpreds_',index,'.RDS'))
  saveRDS(imp, file = paste0('./results/RFimp_',index,'.RDS'))
  saveRDS(sum_stat, file = paste0('./results/ss_',index,'.RDS'))
  ggsave(imp_plot, file = paste0('./viz/RFimpplot_',index,'.png'))
  return(list)

}

rf_2008 <- rf_year(2008)
rf_2009 <- rf_year(2009)
rf_2010 <- rf_year(2010)
rf_2011 <- rf_year(2011)
rf_2012 <- rf_year(2012)
rf_2013 <- rf_year(2013)
rf_2014 <- rf_year(2014)
rf_2015 <- rf_year(2015)
rf_2016 <- rf_year(2016)
rf_2017 <- rf_year(2017)
rf_2018 <- rf_year(2018)
```


### Subset RFs by FRR
```{r}
# remove variables that contributed least to the full model
rf_frr <- function(frr) {
  
  #index
  index <- frr
  
  # build data
  yield_RF <- yield_RF_reduced %>% 
  filter(FRR == frr) %>% 
  dplyr::select(-c(FRR))
  
  # build training and test sets
  set.seed(1234) 
  random_rn <- sample(nrow(yield_RF), ceiling(nrow(yield_RF)*.25)) 
  train <- yield_RF[-random_rn,] 
  test <- yield_RF[random_rn,] 
  
  sum_stat <- test %>% 
  summarise(mean = mean(YIELD),
           median = median(YIELD),
           sd = sd(YIELD))
    
  # build RF on training data
  rf_yield <- randomForest(YIELD ~ ., data = train)
  rf_yield
  
  # build predictions on test set
  preds <- predict(rf_yield, test, type = "response")
  test$PREDICTIONS <- preds
  
  # build MSE/RMSE
  MSE <- mean((test$YIELD - test$PREDICTIONS)^2)
  RMSE <- caret::RMSE(test$PREDICTIONS, test$YIELD)
  R2 <- 1 - (sum((test$YIELD - test$PREDICTIONS)^2) / sum((test$YIELD - mean(test$YIELD))^2))
  pR2 <- 1 - MSE / var(test$YIELD)
  
  # build clean dataframe
  colnames(test)[22] <- paste0('PREDS_',index)
  test <- test %>% mutate(FRR = paste0('FRR',index))
  
  # importance plots
  imp <- as.data.frame(importance(rf_yield))
  imp$varnames <- rownames(imp) # row names to column
  
  imp_plot <- ggplot(imp, aes(x=reorder(varnames, IncNodePurity), y=IncNodePurity)) + 
  geom_point() +
  geom_segment(aes(x=varnames,xend=varnames,y=0,yend=IncNodePurity)) +
  ylab("Increase in node purity") +
  xlab("") +
  coord_flip() +
  theme_minimal()
    
  colnames(imp)[1] <- paste0('IncPurity_',index)
  
  # build argument to feed save, below
  list <- list("MSE" = MSE, "RMSE" = RMSE, "R2" = R2, "pR2" = pR2, "var_exp" = rf_yield, "pR2" = pR2)
  
  # return
  saveRDS(test, file = paste0('./results/RFpreds_',index,'.RDS'))
  saveRDS(imp, file = paste0('./results/RFimp_',index,'.RDS'))
  saveRDS(sum_stat, file = paste0('./results/ss_',index,'.RDS'))
  ggsave(imp_plot, file = paste0('./viz/RFimpplot_',index,'.png'))
  return(list)

}

rf_1 <- rf_frr(1)
rf_2 <- rf_frr(2)
rf_3 <- rf_frr(3)
rf_4 <- rf_frr(4)
rf_5 <- rf_frr(5)
rf_6 <- rf_frr(6)
rf_7 <- rf_frr(7)
rf_8 <- rf_frr(8)
rf_9 <- rf_frr(9)

#test <- RFpreds_8 %>% select(YIELD, PREDS_8)
```
