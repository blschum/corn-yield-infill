---
title: "Corn Yield Random Forest: Visualizations"
author: "Britta Schumacher"
date: "Last updated: `r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    theme: yeti
    toc: yes
    toc_float: true
    code_folding: hide
---

# Bring in the data, clean it up, and start visualizing.

Let's first bring in the data, clean it up, and make it spatial!
```{r warning = F, message = F}
library(ggplot2)
library(sp)
library(tidyverse)
library(tmap)
library(RColorBrewer)
library(rgeos)
library(spdplyr)
library(viridis)
library(rgdal)
library(rgeos)
library(ggthemes)
library(ggalt)
library(maps)
library(maptools)
library(grid)
library(biscale)
library(ggcorrplot)
library(ggimage)
library(png)
library(gridExtra)
library(cowplot)
library(wesanderson)
library(ggpubr)

# Bring in data
biophcv_preds <- readRDS('./results/biofull_cvpreds_ave.RDS')
farmercv_preds <- readRDS('./results/farmerfull_cvpreds_ave.RDS')
reducedcv_preds <- readRDS("./results/sp_cl_cvpreds_ave.RDS")
infill <- readRDS("./results/ranger-results/infill.RDS")
ctys <- readRDS("./data/county.RDS")
state <- readRDS("./data/states.RDS")
frr <- readRDS("./data/FRR.RDS")
corn_yield <- readRDS("./data/yieldRF.RDS")
panel <- readRDS("./data/data-out/panel.RDS")

getmode <- function(v) {
  uniqv <- unique(v)
  uniqv[which.max(tabulate(match(v, uniqv)))]
}

#Aggregate counties to the regional boundaries:
library(maptools)
frr_agg <- unionSpatialPolygons(SpP = frr, IDs = frr$FRR)
frr_final <- aggregate(frr["FRR"], frr_agg, FUN = getmode)

# Make infill spatial
infill_sp <- merge(ctys, infill, by = "GEOID", duplicateGeoms = TRUE)
```

## Figure 1. Farm Resource Region (FRR) boundaries and average corn yield (bushels per acre) recorded in USDA-NASS Surveys between 2008 and 2018; µpanel = 142.2 bushels/acre (9.56 tons/hectare), sdpanel = 39.4 bushels/ acre (2.65 tons/hectare). FRRs as follows: 1) Heartland; 2) Northern Crescent; 3) Northern Great Plains; 4) Prairie Gateway; 5) Eastern Uplands; 6) Southern Seaboard; 7) Fruitful Rim; 8) Basin & Range; and 9) Mississippi Portal. Note: The “missing” category refers to all counties where NASS reported no corn yields from 2008-2018; these counties may be “missing” because they produced no corn, or, more likely, because there were not enough reporting growers to meet NASS statistical disclosure requirements.
```{r}
# Build yield
y <- corn_yield %>% dplyr::select(GEOID,YEAR,YIELD) %>% group_by(GEOID) %>% summarise(ave = mean(YIELD))

corn_yield %>% summarise(mean_yield = mean(YIELD),
                         sd_yield = sd(YIELD))
y_sp <- merge(ctys, y, by = "GEOID")

map <- tm_shape(y_sp) +
  tm_polygons(col = "ave", breaks = c(25,75,100,125,150,175,200,225,275), palette = "Greens", border.col = "transparent", title = "Corn Yield\n(bu/acre)") +
  tm_legend(outside = TRUE) +
  tm_layout(frame = FALSE) +
    tm_shape(frr_final) +
  tm_borders(col = "black")

map

tmap_save(map, file = './viz/Figure1.jpeg', dpi = 400)
```

## Figure 2. Permutation variable importance for the A) biophysical and B) farmer RF resubstitution models of corn yield. The covariates appear on the y-axis and their contribution to decreased variance on the x-axis. Variables are listed in order of importance, with the most important variable being year and least important being mean temperature of the wettest quarter in panel A, and years of experience in panel B; see SI Table 1 for variable names, units, and descriptions.
```{r}
farmer.imp <- readRDS("./results/ranger-imp/farmer_resub_RFimp.RDS")

farmer.imp$varfull <- c("Year","Irrigation","Farm Resource Regions","Growing degree days","Mean diurnal range","Precipitation of the warmest quarter","Shannon's Diversity Index","Mean temperature of the driest quarter","Temperature seasonality","Total precipitation","Elevation","Subsoil pH","Slope","Mean temperature of the wettest quarter","Precipitation of the coldest quarter","Topsoil cation exchange capacity ~ soil","Precipitation seasonality","Topsoil reference bulk density","Topsoil organic carbon","Corn acreage","Chemicals","Fertilizer","Labor", "Machinery", "Insurance","Government receipts","Years experience", "% farming as primary occupation",  "% tenants","Median farm size", "Longitude", "Latitude")

farmer_imp_plot <- ggplot(farmer.imp, aes(x=reorder(varfull, VI), y=VI)) + 
  geom_point() +
  geom_segment(aes(x=varfull,xend=varfull,y=0,yend=VI)) +
  ylab("Decrease in variance") +
  xlab("") +
  coord_flip() +
  theme_minimal()


bio.imp <- readRDS("./results/ranger-imp/bio_resub_RFimp.RDS")

bio.imp$varfull <- c("Year","Irrigation","Farm Resource Regions","Growing degree days","Mean diurnal range","Precipitation of the warmest quarter","Shannon's Diversity Index","Mean temperature of the driest quarter","Temperature seasonality","Total precipitation","Elevation","Subsoil pH","Slope","Mean temperature of the wettest quarter","Precipitation of the coldest quarter","Topsoil cation exchange capacity ~ soil","Precipitation seasonality","Topsoil reference bulk density","Topsoil organic carbon", "Longitude", "Latitude")

bio_imp_plot <- ggplot(bio.imp, aes(x=reorder(varfull, VI), y=VI)) + 
  geom_point() +
  geom_segment(aes(x=varfull,xend=varfull,y=0,yend=VI)) +
  ylab("Decrease in variance") +
  xlab("") +
  coord_flip() +
  theme_minimal()

plot_grid(bio_imp_plot, farmer_imp_plot, ncol = 2, labels = c("A.", "B."))
ggsave("./viz/Figure2.jpeg", dpi = 400, width = 240, height  = 120, units = "mm", bg = "white")
```
## Figure 3. Comparison of change in the 5-fold cross validation accuracy when variable groups are removed from the model. The dashed line represents the median accuracy metric for the model including all variables. The boxplots represent the range of errors observed in 50 replications of cross validation. Error metrics include the root mean square error (RMSE), the median absolute error (MAE), and the symmetric mean absolute percentage error (SMAPE). 
```{r}
load("results/cv_results_11122022.Rdata")
source("scripts/formula_prep.R")

p1 <- tdf |> filter(formula != 1) |>
  ggplot(aes(x = factor(formula, levels = c(5, 2, 3, 4, 6:15)), 
             y = sqrt(rmse))) + 
  geom_hline(yintercept = sqrt(median(tdf$rmse[tdf$formula == 1])), 
             lwd = 1, lty = 2) + 
  geom_boxplot() + 
  scale_x_discrete(labels = formula_labels[c(5, 2, 3, 4, 6:15)]) + 
  scale_y_continuous(limits = c(16.4, 20.6), breaks = seq(16.5, 20.5, 1)) + 
  coord_flip() +
  xlab("") + 
  ylab("RMSE") + 
  theme_bw() + 
  theme(text = element_text(size = 16))

p2 <- tdf |> filter(formula != 1) |>
  ggplot(aes(x = factor(formula, levels = c(5, 2, 3, 4, 6:15)), 
             y = mae)) + 
  geom_hline(yintercept = median(tdf$mae[tdf$formula == 1]), 
             lwd = 1, lty = 2) + 
  geom_boxplot() + 
  scale_x_discrete(labels = formula_labels[c(5, 2, 3, 4, 6:15)]) + 
  scale_y_continuous(limits = c(9.5, 12.5), breaks = seq(9.5, 12.5, 1)) + 
  coord_flip() +
  xlab("") + 
  ylab("MAE") + 
  theme_bw() + 
  theme(text = element_text(size = 16),
        axis.text.y = element_blank(), 
        axis.ticks.y = element_blank())

p3 <- tdf |> filter(formula != 1) |>
  ggplot(aes(x = factor(formula, levels = c(5, 2, 3, 4, 6:15)), 
             y = mape*100)) + 
  geom_hline(yintercept = median(tdf$mape[tdf$formula == 1]*100), 
             lwd = 1, lty = 2) + 
  geom_boxplot() + 
  scale_x_discrete(labels = formula_labels[c(5, 2, 3, 4, 6:15)]) + 
  scale_y_continuous(limits = c(11, 15), breaks = seq(11, 15, 1)) + 
  coord_flip() +
  xlab("") + 
  ylab("MAPE") + 
  theme_bw() + 
  theme(text = element_text(size = 16),
        axis.text.y = element_blank(), 
        axis.ticks.y = element_blank())

#pdf(file = "results/test_importance.pdf", width = 10, height = 6)
jpeg(file = "viz/Figure3.jpeg", width = 10, height = 6,
     units = "in", res = 400)
gridExtra::grid.arrange(p1, p2, p3, widths = c(15, 8, 8), nrow = 1)
dev.off()

```

## Figure 4: Permutation variable importance for the reduced resubstitution models of corn yield. The covariates appear on the y-axis and their contribution to decreased variance on the x-axis. Variables are listed in order of importance, with the most important variable being longitude and least important being mean temperature of the wettest quarter; see SI Table 1 for variable names, units, and descriptions
```{r}
reduced.imp <- readRDS("./results/ranger-imp/reduced_resub_RFimp.RDS")

reduced.imp$varfull <- c("Year","Longitude", "Latitude","Irrigation","Growing degree days","Mean diurnal range","Temperature seasonality","Mean temperature of the wettest quarter","Mean temperature of the driest quarter","Precipitation seasonality","Precipitation of the warmest quarter","Precipitation of the coldest quarter","Total precipitation")

reduced_imp_plot <- ggplot(reduced.imp, aes(x=reorder(varfull, VI), y=VI)) + 
  geom_point() +
  geom_segment(aes(x=varfull,xend=varfull,y=0,yend=VI)) +
  ylab("Decrease in variance") +
  xlab("") +
  coord_flip() +
  theme_minimal()

ggsave("./viz/Figure4.jpeg", dpi = 400, width = 240, height  = 120, units = "mm", bg = "white")

```

## Figure 5. US corn yield in ensemble predicted infilled dataset.
```{r}
### counties with all 11 years of yield data
full_report <- corn_yield %>% mutate(tally = 1) %>% group_by(GEOID) %>% summarise(count = sum(tally)) %>% distinct() %>% filter(count == 11) %>% 
  mutate(full = case_when(
    count == 11 ~ "All yield data reported"))
  
fr_sp <- merge(ctys, full_report, by = "GEOID", all = FALSE)

ctys_df <- as.data.frame(ctys)
ctys_nodata <- ctys_df %>% filter(!(GEOID %in% corn_yield$GEOID)) %>% mutate(type = "No yield data reported")
ctys_nodata_sp <- merge(ctys, ctys_nodata, by = "GEOID", all = FALSE)

#### REDUCED

# Take only counties with at least one year of corn yield data
infill_sum <- infill %>% group_by(GEOID) %>% summarise(ave = mean(average_prediction)) %>% filter(GEOID %in% corn_yield$GEOID)

infill_sum_sp <- merge(ctys, infill_sum, by = "GEOID", all=FALSE)


f <- tm_shape(infill_sum_sp) +
  tm_polygons(col = "ave", breaks = c(25,75,100,125,150,175,200,215), palette = "Oranges", border.col = "transparent", title = "Infilled Corn\nYield (bu/acre)", legend.hist = TRUE) +
  tm_legend(outside = TRUE, hist.width = 0.6) +
  tm_layout(frame = FALSE,
            legend.hist.size = 0.6) +
  tm_shape(fr_sp) +
  tm_polygons(col = "full", palette = "black", alpha = 0.8, border.col = "transparent", legend.show=TRUE, title = "") +
  tm_shape(ctys_nodata_sp) +
  tm_polygons(col = "type", palette = "gray", alpha = 0.9, border.col = "transparent", legend.show=TRUE, title = "") +
      tm_shape(frr_final) +
  tm_borders(col = "black") 

f
tmap_save(tm = f, file = './viz/Figure5.jpeg', dpi = 400, width = 8, height = 5)


```


## Figure 6. Partial dependence plots for important variables in the reduced ensemble. Partial dependence is the dependence of the outcome on one predictor after averaging out the effects of all other predictors in the model (Cutler et al., 2007). Partial dependence plots graphically characterize the relationship between an individual predictor (standardized, here) and the predicted values of yield.

#### Reduced partial dependence plots
```{r}
library(tidyverse)
# irrigation
irrs <- corn_yield %>% summarise(mean = mean(PERC_IRR), sd = sd(PERC_IRR))
pdp_irr <- readRDS("./results/ranger-pdp/irr-red.RDS")
pdp_irr$VAR = "Irrigation (% ag acres)"  
pdp_irr$STANDARDIZED = ((pdp_irr$PERC_IRR - irrs$mean) / irrs$sd)
colnames(pdp_irr) <- c("VALUE", "yhat", "VAR", "STANDARDIZED")
# GDD
gdds <- corn_yield %>% summarise(mean = mean(GDD), sd = sd(GDD))
pdp_gdd <- readRDS("./results/ranger-pdp/GDD-red.RDS")
pdp_gdd$VAR <- "Growing degree days (C)"
pdp_gdd$STANDARDIZED <- ((pdp_gdd$GDD - gdds$mean) / gdds$sd)
colnames(pdp_gdd) <- c("VALUE", "yhat", "VAR", "STANDARDIZED")
# BV9
bv9s <- corn_yield %>% summarise(mean = mean(BV9), sd = sd(BV9))
pdp_bv9 <- readRDS("./results/ranger-pdp/BV9-red.RDS")
pdp_bv9$VAR <- "Mean temperature of the driest quarter (C)"
pdp_bv9$STANDARDIZED <- ((pdp_bv9$BV9 - bv9s$mean) / bv9s$sd)
colnames(pdp_bv9) <- c("VALUE", "yhat", "VAR", "STANDARDIZED")
# BV2
bv2s <- corn_yield %>% summarise(mean = mean(BV2), sd = sd(BV2))
pdp_bv2 <- readRDS("./results/ranger-pdp/BV2-red.RDS")
pdp_bv2$VAR <- "Mean diurnal range (C)"
pdp_bv2$STANDARDIZED <- ((pdp_bv2$BV2 - bv2s$mean) / bv2s$sd)
colnames(pdp_bv2) <- c("VALUE", "yhat", "VAR", "STANDARDIZED")
# lat
lats <- panel %>% summarise(mean = mean(lat), sd = sd(lat))
pdp_lat <- readRDS("./results/ranger-pdp/lat-red.RDS")
pdp_lat$VAR <- "Latitude"
pdp_lat$STANDARDIZED <- ((pdp_lat$lat - lats$mean) / lats$sd)
colnames(pdp_lat) <- c("VALUE", "yhat", "VAR", "STANDARDIZED")
# long
lons <- panel %>% summarise(mean = mean(lon), sd = sd(lon))
pdp_lon <- readRDS("./results/ranger-pdp/lon-red.RDS")
pdp_lon$VAR <- "Longitude"
pdp_lon$STANDARDIZED <- ((pdp_lon$lon - lons$mean) / lons$sd)
colnames(pdp_lon) <- c("VALUE", "yhat", "VAR", "STANDARDIZED")
# time
years <- corn_yield %>% summarise(mean = mean(YEAR), sd = sd(YEAR))
pdp_year<- readRDS("./results/ranger-pdp/year-red.RDS")
pdp_year$VAR <- "Year"
pdp_year$STANDARDIZED <- ((pdp_year$YEAR - years$mean) / years$sd)
colnames(pdp_year) <- c("VALUE", "yhat", "VAR", "STANDARDIZED")

# merge into one dataframe
pdp <- rbind(pdp_irr,pdp_gdd,pdp_bv9,pdp_bv2,pdp_year,pdp_lat,pdp_lon)
saveRDS(pdp,"./results/ranger-pdp/reduced-pdp-data.RDS")

reduced_pdp <- ggplot(pdp) +   
  geom_line(aes(x = STANDARDIZED, y = yhat, color = factor(VAR)), size = 1.2) + 
  theme_classic() +
  theme(legend.title = element_blank(), legend.position = "bottom") + 
  scale_colour_manual(values=c("gray","#CCCC99", "#99CC99", "#CC6633", "#4A7DA5", "#99CCFF","#336633")) + 
  labs(y = "Predicted Yield (bu/acre)",
       x = "") +  
  guides(color=guide_legend(nrow=3)) +
  theme(legend.position = "none",
        axis.title.y = element_text(angle = 90, vjust = 0, margin=margin(r=6))) 
reduced_pdp

saveRDS(pdp, "results/ranger-pdp/pdp-reduced-data.RDS")

box_data <- panel %>% 
  select(GEOID, GDD, PERC_IRR, BV9, BV2, lat, lon, YEAR) 
colnames(box_data) <- c("GEOID","Growing Degree Days (C)","Irrigation (% ag acres)","Mean temperature of the direst quarter (C)","Mean diurnal range (C)","Latitude","Longitude","Year")
box_data <- box_data %>% 
  pivot_longer(2:8,names_to = "Variable",values_to = "VAL") %>% 
  group_by(Variable) %>% 
  mutate(mean = mean(VAL), sd = sd(VAL),
         standardized = (VAL - mean) / sd) 

p2 <- ggplot(box_data, aes(x = standardized,
                           y = factor(Variable),
                           color = factor(Variable))) +
  scale_colour_manual(values=c("gray","#CCCC99", "#99CC99", "#CC6633", "#4A7DA5", "#99CCFF","#336633")) +
  geom_boxplot() +
  theme_bw() +
  xlab("Standardized Predictor Value")+
  ylab("") +
  theme(legend.position = "none")

library(cowplot)
cowplot::plot_grid(reduced_pdp, p2, align = "v", ncol = 1, axis = "l",

                   rel_heights = c(3, 1))     

ggsave(file = './viz/Figure6.jpeg', dpi = 400, height = 220, width = 220,units="mm")
```


